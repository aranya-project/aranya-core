---
source: crates/aranya-policy-lang/tests/tests.rs
expression: policy
---
Policy {
    version: V2,
    ffi_imports: [],
    facts: [
        FactDefinition {
            immutable: false,
            identifier: "F" @ 150..151,
            key: [
                FieldDefinition {
                    identifier: "v" @ 152..153,
                    field_type: String @ 154..160,
                },
            ],
            value: [
                FieldDefinition {
                    identifier: "x" @ 164..165,
                    field_type: Int @ 166..169,
                },
                FieldDefinition {
                    identifier: "y" @ 171..172,
                    field_type: Bool @ 173..177,
                },
            ],
            span: 145..178,
        },
    ],
    actions: [
        ActionDefinition {
            persistence: Persistent,
            identifier: "add2" @ 195..199,
            arguments: [
                FieldDefinition {
                    identifier: "x" @ 200..201,
                    field_type: Int @ 202..205,
                },
                FieldDefinition {
                    identifier: "y" @ 207..208,
                    field_type: Int @ 209..212,
                },
            ],
            statements: [
                Let(
                    LetStatement {
                        identifier: "obj" @ 232..235,
                        expression: NamedStruct(
                            NamedStruct {
                                identifier: "Add" @ 238..241,
                                fields: [
                                    (
                                        "count" @ 260..265,
                                        Identifier(
                                            "x" @ 267..268,
                                        ) @ 267..268,
                                    ),
                                ],
                                sources: [],
                            },
                        ) @ 238..283,
                    },
                ) @ 228..296,
                Publish(
                    Identifier(
                        "obj" @ 304..307,
                    ) @ 304..307,
                ) @ 296..316,
            ],
            span: 188..317,
        },
        ActionDefinition {
            persistence: Ephemeral(
                2378..2387,
            ),
            identifier: "a" @ 2395..2396,
            arguments: [],
            statements: [],
            span: 2378..2401,
        },
    ],
    effects: [
        EffectDefinition {
            identifier: "Added" @ 334..339,
            items: [
                Field(
                    EffectFieldDefinition {
                        identifier: "x" @ 354..355,
                        field_type: Int @ 356..359,
                        dynamic: true,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "y" @ 381..382,
                        field_type: Int @ 383..386,
                        dynamic: false,
                    },
                ),
            ],
            span: 327..397,
        },
    ],
    structs: [],
    enums: [],
    commands: [
        CommandDefinition {
            persistence: Persistent,
            attributes: [],
            identifier: "Add" @ 415..418,
            fields: [
                Field(
                    FieldDefinition {
                        identifier: "count" @ 458..463,
                        field_type: Int @ 464..467,
                    },
                ),
            ],
            seal: [],
            open: [],
            policy: [
                Let(
                    LetStatement {
                        identifier: "envelope_id" @ 524..535,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "envelope" @ 538..546,
                                identifier: "command_id" @ 548..558,
                                arguments: [
                                    Identifier(
                                        "envelope" @ 559..567,
                                    ) @ 559..567,
                                ],
                            },
                        ) @ 538..568,
                    },
                ) @ 520..585,
                Let(
                    LetStatement {
                        identifier: "author" @ 589..595,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "envelope" @ 598..606,
                                identifier: "author_id" @ 608..617,
                                arguments: [
                                    Identifier(
                                        "envelope" @ 618..626,
                                    ) @ 618..626,
                                ],
                            },
                        ) @ 598..627,
                    },
                ) @ 585..644,
                Let(
                    LetStatement {
                        identifier: "new_x" @ 648..653,
                        expression: FunctionCall(
                            FunctionCall {
                                identifier: "add2" @ 656..660,
                                arguments: [
                                    Identifier(
                                        "x" @ 661..662,
                                    ) @ 661..662,
                                    Identifier(
                                        "count" @ 664..669,
                                    ) @ 664..669,
                                ],
                            },
                        ) @ 656..670,
                    },
                ) @ 644..687,
                Check(
                    CheckStatement {
                        expression: InternalFunction(
                            Exists(
                                FactLiteral {
                                    identifier: "TestFact" @ 700..708,
                                    key_fields: [
                                        (
                                            "v" @ 709..710,
                                            Expression(
                                                String(
                                                    "test",
                                                ) @ 712..718,
                                            ),
                                        ),
                                    ],
                                    value_fields: Some(
                                        [],
                                    ),
                                },
                            ),
                        ) @ 693..723,
                    },
                ) @ 687..740,
                Match(
                    MatchStatement {
                        expression: Identifier(
                            "x" @ 746..747,
                        ) @ 746..747,
                        arms: [
                            MatchArm {
                                pattern: Values(
                                    [
                                        Int(
                                            0,
                                        ) @ 770..771,
                                    ],
                                ),
                                statements: [
                                    Check(
                                        CheckStatement {
                                            expression: FunctionCall(
                                                FunctionCall {
                                                    identifier: "positive" @ 807..815,
                                                    arguments: [
                                                        Optional(
                                                            Some(
                                                                Identifier(
                                                                    "new_x" @ 821..826,
                                                                ) @ 821..826,
                                                            ),
                                                        ) @ 816..827,
                                                    ],
                                                },
                                            ) @ 807..828,
                                        },
                                    ) @ 801..849,
                                ],
                            },
                            MatchArm {
                                pattern: Values(
                                    [
                                        Int(
                                            1,
                                        ) @ 871..872,
                                    ],
                                ),
                                statements: [
                                    Check(
                                        CheckStatement {
                                            expression: FunctionCall(
                                                FunctionCall {
                                                    identifier: "positive" @ 908..916,
                                                    arguments: [
                                                        Optional(
                                                            None,
                                                        ) @ 917..921,
                                                    ],
                                                },
                                            ) @ 908..922,
                                        },
                                    ) @ 902..943,
                                ],
                            },
                            MatchArm {
                                pattern: Default(
                                    965..966,
                                ),
                                statements: [],
                            },
                        ],
                    },
                ) @ 740..1012,
                If(
                    IfStatement {
                        branches: [
                            (
                                Equal(
                                    Identifier(
                                        "x" @ 1033..1034,
                                    ) @ 1033..1034,
                                    Int(
                                        3,
                                    ) @ 1038..1039,
                                ) @ 1033..1039,
                                [
                                    Check(
                                        CheckStatement {
                                            expression: LessThan(
                                                Identifier(
                                                    "new_x" @ 1068..1073,
                                                ) @ 1068..1073,
                                                Int(
                                                    10,
                                                ) @ 1076..1078,
                                            ) @ 1068..1078,
                                        },
                                    ) @ 1062..1095,
                                ],
                            ),
                        ],
                        fallback: None,
                    },
                ) @ 1030..1114,
                Let(
                    LetStatement {
                        identifier: "a" @ 1118..1119,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "foo" @ 1122..1125,
                                identifier: "ext_func" @ 1127..1135,
                                arguments: [
                                    Identifier(
                                        "x" @ 1136..1137,
                                    ) @ 1136..1137,
                                ],
                            },
                        ) @ 1122..1138,
                    },
                ) @ 1114..1156,
                Finish(
                    [
                        Create(
                            CreateStatement {
                                fact: FactLiteral {
                                    identifier: "F" @ 1192..1193,
                                    key_fields: [
                                        (
                                            "v" @ 1194..1195,
                                            Expression(
                                                String(
                                                    "hello",
                                                ) @ 1197..1204,
                                            ),
                                        ),
                                    ],
                                    value_fields: Some(
                                        [
                                            (
                                                "x" @ 1208..1209,
                                                Expression(
                                                    Identifier(
                                                        "x" @ 1211..1212,
                                                    ) @ 1211..1212,
                                                ),
                                            ),
                                            (
                                                "y" @ 1214..1215,
                                                Expression(
                                                    FunctionCall(
                                                        FunctionCall {
                                                            identifier: "saturating_sub" @ 1217..1231,
                                                            arguments: [
                                                                Int(
                                                                    0,
                                                                ) @ 1232..1233,
                                                                Identifier(
                                                                    "x" @ 1235..1236,
                                                                ) @ 1235..1236,
                                                            ],
                                                        },
                                                    ) @ 1217..1237,
                                                ),
                                            ),
                                        ],
                                    ),
                                },
                            },
                        ) @ 1185..1238,
                        Update(
                            UpdateStatement {
                                fact: FactLiteral {
                                    identifier: "F" @ 1266..1267,
                                    key_fields: [],
                                    value_fields: Some(
                                        [
                                            (
                                                "x" @ 1272..1273,
                                                Expression(
                                                    Identifier(
                                                        "x" @ 1275..1276,
                                                    ) @ 1275..1276,
                                                ),
                                            ),
                                        ],
                                    ),
                                },
                                to: [
                                    (
                                        "x" @ 1282..1283,
                                        Expression(
                                            Identifier(
                                                "new_x" @ 1285..1290,
                                            ) @ 1285..1290,
                                        ),
                                    ),
                                ],
                            },
                        ) @ 1259..1291,
                        Delete(
                            DeleteStatement {
                                fact: FactLiteral {
                                    identifier: "F" @ 1319..1320,
                                    key_fields: [
                                        (
                                            "v" @ 1321..1322,
                                            Expression(
                                                String(
                                                    "hello",
                                                ) @ 1324..1331,
                                            ),
                                        ),
                                    ],
                                    value_fields: None,
                                },
                            },
                        ) @ 1312..1353,
                        Emit(
                            NamedStruct(
                                NamedStruct {
                                    identifier: "Added" @ 1358..1363,
                                    fields: [
                                        (
                                            "x" @ 1390..1391,
                                            Identifier(
                                                "new_x" @ 1393..1398,
                                            ) @ 1393..1398,
                                        ),
                                        (
                                            "y" @ 1424..1425,
                                            Identifier(
                                                "count" @ 1427..1432,
                                            ) @ 1427..1432,
                                        ),
                                    ],
                                    sources: [],
                                },
                            ) @ 1358..1455,
                        ) @ 1353..1472,
                    ],
                ) @ 1156..1473,
            ],
            recall: [
                Let(
                    LetStatement {
                        identifier: "envelope_id" @ 1529..1540,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "envelope" @ 1543..1551,
                                identifier: "command_id" @ 1553..1563,
                                arguments: [
                                    Identifier(
                                        "envelope" @ 1564..1572,
                                    ) @ 1564..1572,
                                ],
                            },
                        ) @ 1543..1573,
                    },
                ) @ 1525..1590,
                Let(
                    LetStatement {
                        identifier: "author" @ 1594..1600,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "envelope" @ 1603..1611,
                                identifier: "author_id" @ 1613..1622,
                                arguments: [
                                    Identifier(
                                        "envelope" @ 1623..1631,
                                    ) @ 1623..1631,
                                ],
                            },
                        ) @ 1603..1632,
                    },
                ) @ 1590..1649,
                Let(
                    LetStatement {
                        identifier: "new_x" @ 1653..1658,
                        expression: FunctionCall(
                            FunctionCall {
                                identifier: "add2" @ 1661..1665,
                                arguments: [
                                    Identifier(
                                        "x" @ 1666..1667,
                                    ) @ 1666..1667,
                                    Identifier(
                                        "count" @ 1669..1674,
                                    ) @ 1669..1674,
                                ],
                            },
                        ) @ 1661..1675,
                    },
                ) @ 1649..1692,
                Finish(
                    [
                        Create(
                            CreateStatement {
                                fact: FactLiteral {
                                    identifier: "F" @ 1728..1729,
                                    key_fields: [
                                        (
                                            "v" @ 1730..1731,
                                            Expression(
                                                String(
                                                    "hello",
                                                ) @ 1733..1740,
                                            ),
                                        ),
                                    ],
                                    value_fields: Some(
                                        [
                                            (
                                                "x" @ 1744..1745,
                                                Expression(
                                                    Identifier(
                                                        "x" @ 1747..1748,
                                                    ) @ 1747..1748,
                                                ),
                                            ),
                                            (
                                                "y" @ 1750..1751,
                                                Expression(
                                                    FunctionCall(
                                                        FunctionCall {
                                                            identifier: "saturating_sub" @ 1753..1767,
                                                            arguments: [
                                                                Int(
                                                                    0,
                                                                ) @ 1768..1769,
                                                                Identifier(
                                                                    "x" @ 1771..1772,
                                                                ) @ 1771..1772,
                                                            ],
                                                        },
                                                    ) @ 1753..1773,
                                                ),
                                            ),
                                        ],
                                    ),
                                },
                            },
                        ) @ 1721..1774,
                        Update(
                            UpdateStatement {
                                fact: FactLiteral {
                                    identifier: "F" @ 1802..1803,
                                    key_fields: [],
                                    value_fields: Some(
                                        [
                                            (
                                                "x" @ 1808..1809,
                                                Expression(
                                                    Identifier(
                                                        "x" @ 1811..1812,
                                                    ) @ 1811..1812,
                                                ),
                                            ),
                                        ],
                                    ),
                                },
                                to: [
                                    (
                                        "x" @ 1818..1819,
                                        Expression(
                                            Identifier(
                                                "new_x" @ 1821..1826,
                                            ) @ 1821..1826,
                                        ),
                                    ),
                                ],
                            },
                        ) @ 1795..1827,
                        Delete(
                            DeleteStatement {
                                fact: FactLiteral {
                                    identifier: "F" @ 1855..1856,
                                    key_fields: [
                                        (
                                            "v" @ 1857..1858,
                                            Expression(
                                                String(
                                                    "hello",
                                                ) @ 1860..1867,
                                            ),
                                        ),
                                    ],
                                    value_fields: None,
                                },
                            },
                        ) @ 1848..1889,
                        Emit(
                            NamedStruct(
                                NamedStruct {
                                    identifier: "Added" @ 1894..1899,
                                    fields: [
                                        (
                                            "x" @ 1926..1927,
                                            Identifier(
                                                "new_x" @ 1929..1934,
                                            ) @ 1929..1934,
                                        ),
                                        (
                                            "y" @ 1960..1961,
                                            Identifier(
                                                "count" @ 1963..1968,
                                            ) @ 1963..1968,
                                        ),
                                    ],
                                    sources: [],
                                },
                            ) @ 1894..1991,
                        ) @ 1889..2008,
                    ],
                ) @ 1692..2009,
            ],
            span: 407..2033,
        },
        CommandDefinition {
            persistence: Ephemeral(
                2280..2289,
            ),
            attributes: [],
            identifier: "C" @ 2298..2299,
            fields: [
                Field(
                    FieldDefinition {
                        identifier: "x" @ 2339..2340,
                        field_type: Int @ 2341..2344,
                    },
                ),
            ],
            seal: [],
            open: [],
            policy: [],
            recall: [],
            span: 2280..2368,
        },
    ],
    functions: [
        FunctionDefinition {
            identifier: "positive" @ 2052..2060,
            arguments: [
                FieldDefinition {
                    identifier: "v" @ 2061..2062,
                    field_type: Optional(
                        Int @ 2072..2075,
                    ) @ 2063..2075,
                },
            ],
            return_type: Bool @ 2077..2081,
            statements: [
                Let(
                    LetStatement {
                        identifier: "x" @ 2100..2101,
                        expression: Unwrap(
                            Identifier(
                                "v" @ 2111..2112,
                            ) @ 2111..2112,
                        ) @ 2104..2112,
                    },
                ) @ 2096..2125,
                Return(
                    ReturnStatement {
                        expression: GreaterThan(
                            Identifier(
                                "x" @ 2132..2133,
                            ) @ 2132..2133,
                            Int(
                                0,
                            ) @ 2136..2137,
                        ) @ 2132..2137,
                    },
                ) @ 2125..2146,
            ],
            span: 2043..2147,
        },
    ],
    finish_functions: [
        FinishFunctionDefinition {
            identifier: "next" @ 2173..2177,
            arguments: [
                FieldDefinition {
                    identifier: "x" @ 2178..2179,
                    field_type: Int @ 2180..2183,
                },
            ],
            statements: [
                Create(
                    CreateStatement {
                        fact: FactLiteral {
                            identifier: "Next" @ 2206..2210,
                            key_fields: [],
                            value_fields: Some(
                                [],
                            ),
                        },
                    },
                ) @ 2199..2216,
            ],
            span: 2157..2226,
        },
    ],
    global_lets: [],
    text: "\n        // This is not a valid policy. It is just meant to exercise\n        // every feature of the parser.\n        /* block comment */\n        fact F[v string]=>{x int, y bool}\n\n        action add2(x int, y int) {\n            let obj = Add {\n                count: x,\n            }\n            publish obj\n        }\n\n        effect Added {\n            x int dynamic,\n            y int,\n        }\n\n        command Add {\n            fields {\n                count int\n            }\n\n            policy {\n                let envelope_id = envelope::command_id(envelope)\n                let author = envelope::author_id(envelope)\n                let new_x = add2(x, count)\n                check exists TestFact[v: \"test\"]=>{}\n                match x {\n                    0 => {\n                        check positive(Some(new_x))\n                    }\n                    1 => {\n                        check positive(None)\n                    }\n                    _ => {\n\n                    }\n                }\n\n                if x == 3 {\n                    check new_x < 10\n                }\n\n                let a = foo::ext_func(x)\n\n                finish {\n                    create F[v: \"hello\"]=>{x: x, y: saturating_sub(0, x)}\n                    update F[]=>{x: x} to {x: new_x}\n                    delete F[v: \"hello\"]\n                    emit Added {\n                        x: new_x,\n                        y: count,\n                    }\n                }\n            }\n            recall {\n                let envelope_id = envelope::command_id(envelope)\n                let author = envelope::author_id(envelope)\n                let new_x = add2(x, count)\n                finish {\n                    create F[v: \"hello\"]=>{x: x, y: saturating_sub(0, x)}\n                    update F[]=>{x: x} to {x: new_x}\n                    delete F[v: \"hello\"]\n                    emit Added {\n                        x: new_x,\n                        y: count,\n                    }\n                }\n            }\n        }\n\n        function positive(v optional int) bool {\n            let x = unwrap v\n            return x > 0\n        }\n\n        finish function next(x int) {\n            create Next[]=>{}\n        }\n\n\n        // ephemeral commands and actions\n\n        ephemeral command C {\n            fields {\n                x int\n            }\n        }\n\n        ephemeral action a() {}\n    ",
}
