---
source: crates/aranya-policy-lang/tests/tests.rs
expression: ast
---
Policy {
    version: V2,
    ffi_imports: [],
    facts: [
        FactDefinition {
            immutable: false,
            identifier: "Players" @ 42..49,
            key: [
                FieldDefinition {
                    identifier: "gameID" @ 50..56,
                    field_type: Id @ 57..59,
                },
            ],
            value: [
                FieldDefinition {
                    identifier: "x" @ 63..64,
                    field_type: Id @ 65..67,
                },
                FieldDefinition {
                    identifier: "o" @ 69..70,
                    field_type: Id @ 71..73,
                },
            ],
            span: 37..74,
        },
        FactDefinition {
            immutable: false,
            identifier: "NextPlayer" @ 80..90,
            key: [
                FieldDefinition {
                    identifier: "gameID" @ 91..97,
                    field_type: Id @ 98..100,
                },
            ],
            value: [
                FieldDefinition {
                    identifier: "p" @ 104..105,
                    field_type: String @ 106..112,
                },
            ],
            span: 75..113,
        },
        FactDefinition {
            immutable: false,
            identifier: "Field" @ 119..124,
            key: [
                FieldDefinition {
                    identifier: "gameID" @ 125..131,
                    field_type: Id @ 132..134,
                },
                FieldDefinition {
                    identifier: "x" @ 136..137,
                    field_type: Int @ 138..141,
                },
                FieldDefinition {
                    identifier: "y" @ 143..144,
                    field_type: Int @ 145..148,
                },
            ],
            value: [
                FieldDefinition {
                    identifier: "p" @ 152..153,
                    field_type: String @ 154..160,
                },
            ],
            span: 114..161,
        },
        FactDefinition {
            immutable: false,
            identifier: "GameOver" @ 167..175,
            key: [
                FieldDefinition {
                    identifier: "gameID" @ 176..182,
                    field_type: Id @ 183..185,
                },
            ],
            value: [],
            span: 162..190,
        },
    ],
    actions: [
        ActionDefinition {
            persistence: Persistent,
            identifier: "StartGame" @ 609..618,
            arguments: [
                Param {
                    name: "profileX" @ 619..627,
                    ty: Id @ 628..630,
                },
                Param {
                    name: "profileO" @ 632..640,
                    ty: Id @ 641..643,
                },
            ],
            statements: [
                Let(
                    LetStatement {
                        identifier: "start_command" @ 655..668,
                        expression: NamedStruct(
                            NamedStruct {
                                identifier: "Start" @ 671..676,
                                fields: [
                                    (
                                        "ProfileX" @ 686..694,
                                        Identifier(
                                            "profileX" @ 696..704,
                                        ) @ 696..704,
                                    ),
                                    (
                                        "ProfileO" @ 714..722,
                                        Identifier(
                                            "profileO" @ 724..732,
                                        ) @ 724..732,
                                    ),
                                ],
                                sources: [],
                            },
                        ) @ 671..739,
                    },
                ) @ 651..744,
                Publish(
                    Identifier(
                        "start_command" @ 752..765,
                    ) @ 752..765,
                ) @ 744..766,
            ],
            span: 602..767,
        },
        ActionDefinition {
            persistence: Persistent,
            identifier: "MakeMove" @ 1444..1452,
            arguments: [
                Param {
                    name: "gameID" @ 1453..1459,
                    ty: Id @ 1460..1462,
                },
                Param {
                    name: "x" @ 1464..1465,
                    ty: Int @ 1466..1469,
                },
                Param {
                    name: "y" @ 1471..1472,
                    ty: Int @ 1473..1476,
                },
            ],
            statements: [
                Let(
                    LetStatement {
                        identifier: "move_command" @ 1488..1500,
                        expression: NamedStruct(
                            NamedStruct {
                                identifier: "Move" @ 1503..1507,
                                fields: [
                                    (
                                        "gameID" @ 1518..1524,
                                        Identifier(
                                            "gameID" @ 1526..1532,
                                        ) @ 1526..1532,
                                    ),
                                    (
                                        "X" @ 1542..1543,
                                        Identifier(
                                            "x" @ 1545..1546,
                                        ) @ 1545..1546,
                                    ),
                                    (
                                        "Y" @ 1556..1557,
                                        Identifier(
                                            "y" @ 1559..1560,
                                        ) @ 1559..1560,
                                    ),
                                ],
                                sources: [],
                            },
                        ) @ 1503..1567,
                    },
                ) @ 1484..1572,
                Publish(
                    Identifier(
                        "move_command" @ 1580..1592,
                    ) @ 1580..1592,
                ) @ 1572..1593,
            ],
            span: 1437..1594,
        },
    ],
    effects: [
        EffectDefinition {
            identifier: "GameStart" @ 776..785,
            items: [
                Field(
                    EffectFieldDefinition {
                        identifier: "gameID" @ 792..798,
                        field_type: Id @ 799..801,
                        dynamic: false,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "x" @ 807..808,
                        field_type: Id @ 809..811,
                        dynamic: false,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "o" @ 817..818,
                        field_type: Id @ 819..821,
                        dynamic: false,
                    },
                ),
            ],
            span: 769..824,
        },
        EffectDefinition {
            identifier: "GameUpdate" @ 1603..1613,
            items: [
                Field(
                    EffectFieldDefinition {
                        identifier: "gameID" @ 1620..1626,
                        field_type: Id @ 1627..1629,
                        dynamic: false,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "player" @ 1635..1641,
                        field_type: Id @ 1642..1644,
                        dynamic: false,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "p" @ 1802..1803,
                        field_type: String @ 1809..1815,
                        dynamic: true,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "X" @ 1829..1830,
                        field_type: Int @ 1836..1839,
                        dynamic: false,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "Y" @ 1845..1846,
                        field_type: Int @ 1852..1855,
                        dynamic: false,
                    },
                ),
            ],
            span: 1596..1858,
        },
        EffectDefinition {
            identifier: "GameOver" @ 1867..1875,
            items: [
                Field(
                    EffectFieldDefinition {
                        identifier: "gameID" @ 1882..1888,
                        field_type: Id @ 1889..1891,
                        dynamic: false,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "winner" @ 1897..1903,
                        field_type: Id @ 1904..1906,
                        dynamic: false,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: "p" @ 1912..1913,
                        field_type: String @ 1914..1920,
                        dynamic: false,
                    },
                ),
            ],
            span: 1860..1923,
        },
    ],
    structs: [],
    enums: [],
    commands: [
        CommandDefinition {
            persistence: Persistent,
            attributes: [],
            identifier: "Start" @ 834..839,
            fields: [
                Field(
                    FieldDefinition {
                        identifier: "ProfileX" @ 863..871,
                        field_type: Id @ 872..874,
                    },
                ),
                Field(
                    FieldDefinition {
                        identifier: "ProfileO" @ 884..892,
                        field_type: Id @ 893..895,
                    },
                ),
            ],
            seal: [],
            open: [],
            policy: [
                Check(
                    CheckStatement {
                        expression: NotEqual(
                            Identifier(
                                "ProfileX" @ 931..939,
                            ) @ 931..939,
                            Identifier(
                                "ProfileO" @ 943..951,
                            ) @ 943..951,
                        ) @ 931..951,
                    },
                ) @ 925..1091,
                Let(
                    LetStatement {
                        identifier: "gameID" @ 1095..1101,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "envelope" @ 1104..1112,
                                identifier: "command_id" @ 1114..1124,
                                arguments: [
                                    Identifier(
                                        "envelope" @ 1125..1133,
                                    ) @ 1125..1133,
                                ],
                            },
                        ) @ 1104..1134,
                    },
                ) @ 1091..1143,
                Finish(
                    [
                        Create(
                            CreateStatement {
                                fact: FactLiteral {
                                    identifier: "PlayerProfile" @ 1171..1184,
                                    key_fields: [
                                        (
                                            "gameID" @ 1185..1191,
                                            Expression(
                                                Identifier(
                                                    "gameID" @ 1193..1199,
                                                ) @ 1193..1199,
                                            ),
                                        ),
                                    ],
                                    value_fields: Some(
                                        [
                                            (
                                                "x" @ 1203..1204,
                                                Expression(
                                                    Identifier(
                                                        "ProfileX" @ 1206..1214,
                                                    ) @ 1206..1214,
                                                ),
                                            ),
                                            (
                                                "o" @ 1216..1217,
                                                Expression(
                                                    Identifier(
                                                        "ProfileO" @ 1219..1227,
                                                    ) @ 1219..1227,
                                                ),
                                            ),
                                        ],
                                    ),
                                },
                            },
                        ) @ 1164..1228,
                        Create(
                            CreateStatement {
                                fact: FactLiteral {
                                    identifier: "NextPlayer" @ 1248..1258,
                                    key_fields: [
                                        (
                                            "gameID" @ 1259..1265,
                                            Expression(
                                                Identifier(
                                                    "gameID" @ 1267..1273,
                                                ) @ 1267..1273,
                                            ),
                                        ),
                                    ],
                                    value_fields: Some(
                                        [
                                            (
                                                "p" @ 1277..1278,
                                                Expression(
                                                    String(
                                                        "X",
                                                    ) @ 1280..1283,
                                                ),
                                            ),
                                        ],
                                    ),
                                },
                            },
                        ) @ 1241..1284,
                        Emit(
                            NamedStruct(
                                NamedStruct {
                                    identifier: "GameStart" @ 1303..1312,
                                    fields: [
                                        (
                                            "gameID" @ 1330..1336,
                                            Identifier(
                                                "gameID" @ 1338..1344,
                                            ) @ 1338..1344,
                                        ),
                                        (
                                            "x" @ 1362..1363,
                                            Identifier(
                                                "ProfileX" @ 1365..1373,
                                            ) @ 1365..1373,
                                        ),
                                        (
                                            "o" @ 1391..1392,
                                            Identifier(
                                                "ProfileO" @ 1394..1402,
                                            ) @ 1394..1402,
                                        ),
                                    ],
                                    sources: [],
                                },
                            ) @ 1303..1417,
                        ) @ 1298..1426,
                    ],
                ) @ 1143..1427,
            ],
            recall: [],
            span: 826..1435,
        },
        CommandDefinition {
            persistence: Persistent,
            attributes: [],
            identifier: "Move" @ 1933..1937,
            fields: [
                Field(
                    FieldDefinition {
                        identifier: "gameID" @ 2002..2008,
                        field_type: Id @ 2009..2011,
                    },
                ),
                Field(
                    FieldDefinition {
                        identifier: "X" @ 2021..2022,
                        field_type: Int @ 2023..2026,
                    },
                ),
                Field(
                    FieldDefinition {
                        identifier: "Y" @ 2036..2037,
                        field_type: Int @ 2038..2041,
                    },
                ),
            ],
            seal: [],
            open: [],
            policy: [
                Let(
                    LetStatement {
                        identifier: "player" @ 2455..2461,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "envelope" @ 2464..2472,
                                identifier: "author_id" @ 2474..2483,
                                arguments: [
                                    Identifier(
                                        "envelope" @ 2484..2492,
                                    ) @ 2484..2492,
                                ],
                            },
                        ) @ 2464..2493,
                    },
                ) @ 2451..2795,
                Let(
                    LetStatement {
                        identifier: "result" @ 2799..2805,
                        expression: Unwrap(
                            InternalFunction(
                                Query(
                                    FactLiteral {
                                        identifier: "PlayerProfile" @ 2821..2834,
                                        key_fields: [
                                            (
                                                "gameID" @ 2835..2841,
                                                Expression(
                                                    Identifier(
                                                        "gameID" @ 2843..2849,
                                                    ) @ 2843..2849,
                                                ),
                                            ),
                                        ],
                                        value_fields: Some(
                                            [
                                                (
                                                    "x" @ 2853..2854,
                                                    Bind(
                                                        2856..2857,
                                                    ),
                                                ),
                                                (
                                                    "o" @ 2859..2860,
                                                    Bind(
                                                        2862..2863,
                                                    ),
                                                ),
                                            ],
                                        ),
                                    },
                                ),
                            ) @ 2815..2864,
                        ) @ 2808..2864,
                    },
                ) @ 2795..2873,
                Let(
                    LetStatement {
                        identifier: "playerX" @ 2877..2884,
                        expression: Dot(
                            Identifier(
                                "result" @ 2887..2893,
                            ) @ 2887..2893,
                            "x" @ 2894..2895,
                        ) @ 2887..2895,
                    },
                ) @ 2873..2904,
                Let(
                    LetStatement {
                        identifier: "playerO" @ 2908..2915,
                        expression: Dot(
                            Identifier(
                                "result" @ 2918..2924,
                            ) @ 2918..2924,
                            "o" @ 2925..2926,
                        ) @ 2918..2926,
                    },
                ) @ 2904..2935,
                Let(
                    LetStatement {
                        identifier: "p" @ 2939..2940,
                        expression: Unwrap(
                            InternalFunction(
                                Query(
                                    FactLiteral {
                                        identifier: "NextPlayer" @ 2956..2966,
                                        key_fields: [
                                            (
                                                "gameID" @ 2967..2973,
                                                Expression(
                                                    Identifier(
                                                        "gameID" @ 2975..2981,
                                                    ) @ 2975..2981,
                                                ),
                                            ),
                                        ],
                                        value_fields: Some(
                                            [
                                                (
                                                    "p" @ 2985..2986,
                                                    Bind(
                                                        2988..2989,
                                                    ),
                                                ),
                                            ],
                                        ),
                                    },
                                ),
                            ) @ 2950..2990,
                        ) @ 2943..2990,
                    },
                ) @ 2935..3111,
                Let(
                    LetStatement {
                        identifier: "nextp" @ 3115..3120,
                        expression: InternalFunction(
                            If(
                                Equal(
                                    Identifier(
                                        "p" @ 3126..3127,
                                    ) @ 3126..3127,
                                    String(
                                        "X",
                                    ) @ 3131..3134,
                                ) @ 3126..3134,
                                Block(
                                    [],
                                    String(
                                        "O",
                                    ) @ 3138..3141,
                                ) @ 3135..3143,
                                Block(
                                    [],
                                    String(
                                        "X",
                                    ) @ 3152..3155,
                                ) @ 3149..3157,
                            ),
                        ) @ 3123..3157,
                    },
                ) @ 3111..3400,
                Check(
                    CheckStatement {
                        expression: Or(
                            And(
                                Equal(
                                    Identifier(
                                        "p" @ 3407..3408,
                                    ) @ 3407..3408,
                                    String(
                                        "X",
                                    ) @ 3412..3415,
                                ) @ 3407..3415,
                                Equal(
                                    Identifier(
                                        "player" @ 3419..3425,
                                    ) @ 3419..3425,
                                    Identifier(
                                        "playerX" @ 3429..3436,
                                    ) @ 3429..3436,
                                ) @ 3419..3436,
                            ) @ 3407..3436,
                            And(
                                Equal(
                                    Identifier(
                                        "p" @ 3442..3443,
                                    ) @ 3442..3443,
                                    String(
                                        "O",
                                    ) @ 3447..3450,
                                ) @ 3442..3450,
                                Equal(
                                    Identifier(
                                        "player" @ 3454..3460,
                                    ) @ 3454..3460,
                                    Identifier(
                                        "playerO" @ 3464..3471,
                                    ) @ 3464..3471,
                                ) @ 3454..3471,
                            ) @ 3442..3471,
                        ) @ 3407..3471,
                    },
                ) @ 3400..3532,
                Check(
                    CheckStatement {
                        expression: FunctionCall(
                            FunctionCall {
                                identifier: "bounds" @ 3538..3544,
                                arguments: [
                                    Identifier(
                                        "X" @ 3545..3546,
                                    ) @ 3545..3546,
                                ],
                            },
                        ) @ 3538..3547,
                    },
                ) @ 3532..3556,
                Check(
                    CheckStatement {
                        expression: FunctionCall(
                            FunctionCall {
                                identifier: "bounds" @ 3562..3568,
                                arguments: [
                                    Identifier(
                                        "Y" @ 3569..3570,
                                    ) @ 3569..3570,
                                ],
                            },
                        ) @ 3562..3571,
                    },
                ) @ 3556..3783,
                Finish(
                    [
                        Create(
                            CreateStatement {
                                fact: FactLiteral {
                                    identifier: "Field" @ 3811..3816,
                                    key_fields: [
                                        (
                                            "gameID" @ 3817..3823,
                                            Expression(
                                                Identifier(
                                                    "gameID" @ 3825..3831,
                                                ) @ 3825..3831,
                                            ),
                                        ),
                                        (
                                            "x" @ 3833..3834,
                                            Expression(
                                                Identifier(
                                                    "X" @ 3836..3837,
                                                ) @ 3836..3837,
                                            ),
                                        ),
                                        (
                                            "y" @ 3839..3840,
                                            Expression(
                                                Identifier(
                                                    "Y" @ 3842..3843,
                                                ) @ 3842..3843,
                                            ),
                                        ),
                                    ],
                                    value_fields: Some(
                                        [
                                            (
                                                "p" @ 3847..3848,
                                                Expression(
                                                    Identifier(
                                                        "p" @ 3850..3851,
                                                    ) @ 3850..3851,
                                                ),
                                            ),
                                        ],
                                    ),
                                },
                            },
                        ) @ 3804..3852,
                        FunctionCall(
                            FunctionCall {
                                identifier: "set_next_player" @ 3865..3880,
                                arguments: [
                                    Identifier(
                                        "gameID" @ 3881..3887,
                                    ) @ 3881..3887,
                                    Identifier(
                                        "nextp" @ 3889..3894,
                                    ) @ 3889..3894,
                                ],
                            },
                        ) @ 3865..3895,
                        Emit(
                            NamedStruct(
                                NamedStruct {
                                    identifier: "GameUpdate" @ 3914..3924,
                                    fields: [
                                        (
                                            "gameID" @ 3942..3948,
                                            Identifier(
                                                "gameID" @ 3950..3956,
                                            ) @ 3950..3956,
                                        ),
                                        (
                                            "player" @ 3974..3980,
                                            Identifier(
                                                "player" @ 3982..3988,
                                            ) @ 3982..3988,
                                        ),
                                        (
                                            "p" @ 4006..4007,
                                            Identifier(
                                                "p" @ 4009..4010,
                                            ) @ 4009..4010,
                                        ),
                                        (
                                            "X" @ 4028..4029,
                                            Identifier(
                                                "X" @ 4031..4032,
                                            ) @ 4031..4032,
                                        ),
                                        (
                                            "Y" @ 4050..4051,
                                            Identifier(
                                                "Y" @ 4053..4054,
                                            ) @ 4053..4054,
                                        ),
                                    ],
                                    sources: [],
                                },
                            ) @ 3914..4069,
                        ) @ 3909..4078,
                    ],
                ) @ 3783..4079,
            ],
            recall: [],
            span: 1925..4087,
        },
        CommandDefinition {
            persistence: Persistent,
            attributes: [],
            identifier: "Move2" @ 5551..5556,
            fields: [
                Field(
                    FieldDefinition {
                        identifier: "gameID" @ 5580..5586,
                        field_type: Id @ 5587..5589,
                    },
                ),
                Field(
                    FieldDefinition {
                        identifier: "X" @ 5599..5600,
                        field_type: Int @ 5601..5604,
                    },
                ),
                Field(
                    FieldDefinition {
                        identifier: "Y" @ 5614..5615,
                        field_type: Int @ 5616..5619,
                    },
                ),
            ],
            seal: [],
            open: [],
            policy: [
                Let(
                    LetStatement {
                        identifier: "player" @ 5653..5659,
                        expression: ForeignFunctionCall(
                            ForeignFunctionCall {
                                module: "envelope" @ 5662..5670,
                                identifier: "author_id" @ 5672..5681,
                                arguments: [
                                    Identifier(
                                        "envelope" @ 5682..5690,
                                    ) @ 5682..5690,
                                ],
                            },
                        ) @ 5662..5691,
                    },
                ) @ 5649..5700,
                Let(
                    LetStatement {
                        identifier: "players" @ 5704..5711,
                        expression: Unwrap(
                            InternalFunction(
                                Query(
                                    FactLiteral {
                                        identifier: "PlayerProfile" @ 5727..5740,
                                        key_fields: [
                                            (
                                                "gameID" @ 5741..5747,
                                                Expression(
                                                    Identifier(
                                                        "gameID" @ 5749..5755,
                                                    ) @ 5749..5755,
                                                ),
                                            ),
                                        ],
                                        value_fields: Some(
                                            [
                                                (
                                                    "x" @ 5759..5760,
                                                    Bind(
                                                        5762..5763,
                                                    ),
                                                ),
                                                (
                                                    "o" @ 5765..5766,
                                                    Bind(
                                                        5768..5769,
                                                    ),
                                                ),
                                            ],
                                        ),
                                    },
                                ),
                            ) @ 5721..5770,
                        ) @ 5714..5770,
                    },
                ) @ 5700..5779,
                Let(
                    LetStatement {
                        identifier: "p" @ 5783..5784,
                        expression: Unwrap(
                            InternalFunction(
                                Query(
                                    FactLiteral {
                                        identifier: "NextPlayer" @ 5800..5810,
                                        key_fields: [
                                            (
                                                "gameID" @ 5811..5817,
                                                Expression(
                                                    Identifier(
                                                        "gameID" @ 5819..5825,
                                                    ) @ 5819..5825,
                                                ),
                                            ),
                                        ],
                                        value_fields: Some(
                                            [
                                                (
                                                    "p" @ 5829..5830,
                                                    Bind(
                                                        5832..5833,
                                                    ),
                                                ),
                                            ],
                                        ),
                                    },
                                ),
                            ) @ 5794..5834,
                        ) @ 5787..5834,
                    },
                ) @ 5779..5843,
                Let(
                    LetStatement {
                        identifier: "nextp" @ 5847..5852,
                        expression: InternalFunction(
                            If(
                                Equal(
                                    Identifier(
                                        "p" @ 5858..5859,
                                    ) @ 5858..5859,
                                    String(
                                        "X",
                                    ) @ 5863..5866,
                                ) @ 5858..5866,
                                Block(
                                    [],
                                    String(
                                        "O",
                                    ) @ 5870..5873,
                                ) @ 5867..5875,
                                Block(
                                    [],
                                    String(
                                        "X",
                                    ) @ 5884..5887,
                                ) @ 5881..5889,
                            ),
                        ) @ 5855..5889,
                    },
                ) @ 5843..5899,
                Check(
                    CheckStatement {
                        expression: Not(
                            InternalFunction(
                                Exists(
                                    FactLiteral {
                                        identifier: "GameOver" @ 5913..5921,
                                        key_fields: [
                                            (
                                                "gameID" @ 5922..5928,
                                                Expression(
                                                    Identifier(
                                                        "gameID" @ 5930..5936,
                                                    ) @ 5930..5936,
                                                ),
                                            ),
                                        ],
                                        value_fields: Some(
                                            [],
                                        ),
                                    },
                                ),
                            ) @ 5906..5941,
                        ) @ 5905..5941,
                    },
                ) @ 5899..5950,
                Check(
                    CheckStatement {
                        expression: FunctionCall(
                            FunctionCall {
                                identifier: "bounds" @ 5956..5962,
                                arguments: [
                                    Identifier(
                                        "X" @ 5963..5964,
                                    ) @ 5963..5964,
                                ],
                            },
                        ) @ 5956..5965,
                    },
                ) @ 5950..5974,
                Check(
                    CheckStatement {
                        expression: FunctionCall(
                            FunctionCall {
                                identifier: "bounds" @ 5980..5986,
                                arguments: [
                                    Identifier(
                                        "Y" @ 5987..5988,
                                    ) @ 5987..5988,
                                ],
                            },
                        ) @ 5980..5989,
                    },
                ) @ 5974..5998,
                Check(
                    CheckStatement {
                        expression: Or(
                            And(
                                Equal(
                                    Identifier(
                                        "p" @ 6005..6006,
                                    ) @ 6005..6006,
                                    String(
                                        "X",
                                    ) @ 6010..6013,
                                ) @ 6005..6013,
                                Equal(
                                    Identifier(
                                        "player" @ 6017..6023,
                                    ) @ 6017..6023,
                                    Dot(
                                        Identifier(
                                            "players" @ 6027..6034,
                                        ) @ 6027..6034,
                                        "x" @ 6035..6036,
                                    ) @ 6027..6036,
                                ) @ 6017..6036,
                            ) @ 6005..6036,
                            And(
                                Equal(
                                    Identifier(
                                        "p" @ 6042..6043,
                                    ) @ 6042..6043,
                                    String(
                                        "O",
                                    ) @ 6047..6050,
                                ) @ 6042..6050,
                                Equal(
                                    Identifier(
                                        "player" @ 6054..6060,
                                    ) @ 6054..6060,
                                    Dot(
                                        Identifier(
                                            "players" @ 6064..6071,
                                        ) @ 6064..6071,
                                        "o" @ 6072..6073,
                                    ) @ 6064..6073,
                                ) @ 6054..6073,
                            ) @ 6042..6073,
                        ) @ 6005..6073,
                    },
                ) @ 5998..6084,
                Match(
                    MatchStatement {
                        expression: FunctionCall(
                            FunctionCall {
                                identifier: "game_over" @ 6090..6099,
                                arguments: [
                                    Identifier(
                                        "gameID" @ 6100..6106,
                                    ) @ 6100..6106,
                                    Identifier(
                                        "X" @ 6108..6109,
                                    ) @ 6108..6109,
                                    Identifier(
                                        "Y" @ 6111..6112,
                                    ) @ 6111..6112,
                                    Identifier(
                                        "p" @ 6114..6115,
                                    ) @ 6114..6115,
                                ],
                            },
                        ) @ 6090..6116,
                        arms: [
                            MatchArm {
                                pattern: Values(
                                    [
                                        Bool(
                                            true,
                                        ) @ 6131..6135,
                                    ],
                                ),
                                statements: [
                                    Finish(
                                        [
                                            Create(
                                                CreateStatement {
                                                    fact: FactLiteral {
                                                        identifier: "Field" @ 6193..6198,
                                                        key_fields: [
                                                            (
                                                                "gameID" @ 6199..6205,
                                                                Expression(
                                                                    Identifier(
                                                                        "gameID" @ 6207..6213,
                                                                    ) @ 6207..6213,
                                                                ),
                                                            ),
                                                            (
                                                                "x" @ 6215..6216,
                                                                Expression(
                                                                    Identifier(
                                                                        "X" @ 6218..6219,
                                                                    ) @ 6218..6219,
                                                                ),
                                                            ),
                                                            (
                                                                "y" @ 6221..6222,
                                                                Expression(
                                                                    Identifier(
                                                                        "Y" @ 6224..6225,
                                                                    ) @ 6224..6225,
                                                                ),
                                                            ),
                                                        ],
                                                        value_fields: Some(
                                                            [
                                                                (
                                                                    "p" @ 6229..6230,
                                                                    Expression(
                                                                        Identifier(
                                                                            "p" @ 6232..6233,
                                                                        ) @ 6232..6233,
                                                                    ),
                                                                ),
                                                            ],
                                                        ),
                                                    },
                                                },
                                            ) @ 6186..6234,
                                            Delete(
                                                DeleteStatement {
                                                    fact: FactLiteral {
                                                        identifier: "NextPlayer" @ 6262..6272,
                                                        key_fields: [
                                                            (
                                                                "gameID" @ 6273..6279,
                                                                Expression(
                                                                    Identifier(
                                                                        "gameID" @ 6281..6287,
                                                                    ) @ 6281..6287,
                                                                ),
                                                            ),
                                                        ],
                                                        value_fields: Some(
                                                            [
                                                                (
                                                                    "p" @ 6291..6292,
                                                                    Expression(
                                                                        Identifier(
                                                                            "p" @ 6294..6295,
                                                                        ) @ 6294..6295,
                                                                    ),
                                                                ),
                                                            ],
                                                        ),
                                                    },
                                                },
                                            ) @ 6255..6296,
                                            Create(
                                                CreateStatement {
                                                    fact: FactLiteral {
                                                        identifier: "GameOver" @ 6324..6332,
                                                        key_fields: [
                                                            (
                                                                "gameID" @ 6333..6339,
                                                                Expression(
                                                                    Identifier(
                                                                        "gameID" @ 6341..6347,
                                                                    ) @ 6341..6347,
                                                                ),
                                                            ),
                                                        ],
                                                        value_fields: Some(
                                                            [],
                                                        ),
                                                    },
                                                },
                                            ) @ 6317..6352,
                                            Emit(
                                                NamedStruct(
                                                    NamedStruct {
                                                        identifier: "GameOver" @ 6378..6386,
                                                        fields: [
                                                            (
                                                                "gameID" @ 6412..6418,
                                                                Identifier(
                                                                    "gameID" @ 6420..6426,
                                                                ) @ 6420..6426,
                                                            ),
                                                            (
                                                                "winner" @ 6452..6458,
                                                                Identifier(
                                                                    "player" @ 6460..6466,
                                                                ) @ 6460..6466,
                                                            ),
                                                            (
                                                                "p" @ 6492..6493,
                                                                Identifier(
                                                                    "p" @ 6495..6496,
                                                                ) @ 6495..6496,
                                                            ),
                                                        ],
                                                        sources: [],
                                                    },
                                                ) @ 6378..6519,
                                            ) @ 6373..6536,
                                        ],
                                    ) @ 6157..6537,
                                ],
                            },
                            MatchArm {
                                pattern: Values(
                                    [
                                        Bool(
                                            false,
                                        ) @ 6564..6569,
                                    ],
                                ),
                                statements: [
                                    Finish(
                                        [
                                            Create(
                                                CreateStatement {
                                                    fact: FactLiteral {
                                                        identifier: "Field" @ 6627..6632,
                                                        key_fields: [
                                                            (
                                                                "gameID" @ 6633..6639,
                                                                Expression(
                                                                    Identifier(
                                                                        "gameID" @ 6641..6647,
                                                                    ) @ 6641..6647,
                                                                ),
                                                            ),
                                                            (
                                                                "x" @ 6649..6650,
                                                                Expression(
                                                                    Identifier(
                                                                        "X" @ 6652..6653,
                                                                    ) @ 6652..6653,
                                                                ),
                                                            ),
                                                            (
                                                                "y" @ 6655..6656,
                                                                Expression(
                                                                    Identifier(
                                                                        "Y" @ 6658..6659,
                                                                    ) @ 6658..6659,
                                                                ),
                                                            ),
                                                        ],
                                                        value_fields: Some(
                                                            [
                                                                (
                                                                    "p" @ 6663..6664,
                                                                    Expression(
                                                                        Identifier(
                                                                            "p" @ 6666..6667,
                                                                        ) @ 6666..6667,
                                                                    ),
                                                                ),
                                                            ],
                                                        ),
                                                    },
                                                },
                                            ) @ 6620..6668,
                                            FunctionCall(
                                                FunctionCall {
                                                    identifier: "set_next_player" @ 6689..6704,
                                                    arguments: [
                                                        Identifier(
                                                            "gameID" @ 6705..6711,
                                                        ) @ 6705..6711,
                                                        Identifier(
                                                            "op" @ 6713..6715,
                                                        ) @ 6713..6715,
                                                    ],
                                                },
                                            ) @ 6689..6716,
                                            Emit(
                                                NamedStruct(
                                                    NamedStruct {
                                                        identifier: "GameUpdate" @ 6742..6752,
                                                        fields: [
                                                            (
                                                                "gameID" @ 6778..6784,
                                                                Identifier(
                                                                    "gameID" @ 6786..6792,
                                                                ) @ 6786..6792,
                                                            ),
                                                            (
                                                                "player" @ 6818..6824,
                                                                Identifier(
                                                                    "player" @ 6826..6832,
                                                                ) @ 6826..6832,
                                                            ),
                                                            (
                                                                "p" @ 6858..6859,
                                                                Identifier(
                                                                    "p" @ 6861..6862,
                                                                ) @ 6861..6862,
                                                            ),
                                                            (
                                                                "x" @ 6888..6889,
                                                                Identifier(
                                                                    "X" @ 6891..6892,
                                                                ) @ 6891..6892,
                                                            ),
                                                            (
                                                                "y" @ 6918..6919,
                                                                Identifier(
                                                                    "Y" @ 6921..6922,
                                                                ) @ 6921..6922,
                                                            ),
                                                        ],
                                                        sources: [],
                                                    },
                                                ) @ 6742..6945,
                                            ) @ 6737..6962,
                                        ],
                                    ) @ 6591..6963,
                                ],
                            },
                        ],
                    },
                ) @ 6084..6987,
            ],
            recall: [],
            span: 5543..6995,
        },
    ],
    functions: [
        FunctionDefinition {
            identifier: "bounds" @ 319..325,
            arguments: [
                Param {
                    name: "v" @ 326..327,
                    ty: Int @ 328..331,
                },
            ],
            return_type: Bool @ 333..337,
            statements: [
                Return(
                    ReturnStatement {
                        expression: And(
                            GreaterThanOrEqual(
                                Identifier(
                                    "v" @ 351..352,
                                ) @ 351..352,
                                Int(
                                    0,
                                ) @ 356..357,
                            ) @ 351..357,
                            LessThanOrEqual(
                                Identifier(
                                    "v" @ 361..362,
                                ) @ 361..362,
                                Int(
                                    2,
                                ) @ 366..367,
                            ) @ 361..367,
                        ) @ 351..367,
                    },
                ) @ 344..368,
            ],
            span: 310..369,
        },
        FunctionDefinition {
            identifier: "game_over" @ 4098..4107,
            arguments: [
                Param {
                    name: "gameID" @ 4108..4114,
                    ty: Id @ 4115..4117,
                },
                Param {
                    name: "x" @ 4119..4120,
                    ty: Int @ 4121..4124,
                },
                Param {
                    name: "y" @ 4126..4127,
                    ty: Int @ 4128..4131,
                },
                Param {
                    name: "p" @ 4133..4134,
                    ty: String @ 4135..4141,
                },
            ],
            return_type: Bool @ 4143..4147,
            statements: [
                Let(
                    LetStatement {
                        identifier: "f00" @ 4158..4161,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4167..4168,
                                        ) @ 4167..4168,
                                        Int(
                                            0,
                                        ) @ 4172..4173,
                                    ) @ 4167..4173,
                                    Equal(
                                        Identifier(
                                            "y" @ 4177..4178,
                                        ) @ 4177..4178,
                                        Int(
                                            0,
                                        ) @ 4182..4183,
                                    ) @ 4177..4183,
                                ) @ 4167..4183,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4192..4193,
                                            ) @ 4192..4193,
                                        ),
                                    ) @ 4187..4194,
                                ) @ 4184..4196,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4211..4216,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4217..4223,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4225..4231,
                                                            ) @ 4225..4231,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4233..4234,
                                                        Expression(
                                                            Int(
                                                                0,
                                                            ) @ 4236..4237,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4239..4240,
                                                        Expression(
                                                            Int(
                                                                0,
                                                            ) @ 4242..4243,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4247..4248,
                                                            Bind(
                                                                4250..4251,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4205..4252,
                                ) @ 4202..4254,
                            ),
                        ) @ 4164..4254,
                    },
                ) @ 4154..4259,
                Let(
                    LetStatement {
                        identifier: "f10" @ 4263..4266,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4272..4273,
                                        ) @ 4272..4273,
                                        Int(
                                            1,
                                        ) @ 4277..4278,
                                    ) @ 4272..4278,
                                    Equal(
                                        Identifier(
                                            "y" @ 4282..4283,
                                        ) @ 4282..4283,
                                        Int(
                                            0,
                                        ) @ 4287..4288,
                                    ) @ 4282..4288,
                                ) @ 4272..4288,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4297..4298,
                                            ) @ 4297..4298,
                                        ),
                                    ) @ 4292..4299,
                                ) @ 4289..4301,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4316..4321,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4322..4328,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4330..4336,
                                                            ) @ 4330..4336,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4338..4339,
                                                        Expression(
                                                            Int(
                                                                1,
                                                            ) @ 4341..4342,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4344..4345,
                                                        Expression(
                                                            Int(
                                                                0,
                                                            ) @ 4347..4348,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4352..4353,
                                                            Bind(
                                                                4355..4356,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4310..4357,
                                ) @ 4307..4359,
                            ),
                        ) @ 4269..4359,
                    },
                ) @ 4259..4364,
                Let(
                    LetStatement {
                        identifier: "f20" @ 4368..4371,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4377..4378,
                                        ) @ 4377..4378,
                                        Int(
                                            2,
                                        ) @ 4382..4383,
                                    ) @ 4377..4383,
                                    Equal(
                                        Identifier(
                                            "y" @ 4387..4388,
                                        ) @ 4387..4388,
                                        Int(
                                            0,
                                        ) @ 4392..4393,
                                    ) @ 4387..4393,
                                ) @ 4377..4393,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4402..4403,
                                            ) @ 4402..4403,
                                        ),
                                    ) @ 4397..4404,
                                ) @ 4394..4406,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4421..4426,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4427..4433,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4435..4441,
                                                            ) @ 4435..4441,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4443..4444,
                                                        Expression(
                                                            Int(
                                                                2,
                                                            ) @ 4446..4447,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4449..4450,
                                                        Expression(
                                                            Int(
                                                                0,
                                                            ) @ 4452..4453,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4457..4458,
                                                            Bind(
                                                                4460..4461,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4415..4462,
                                ) @ 4412..4464,
                            ),
                        ) @ 4374..4464,
                    },
                ) @ 4364..4469,
                Let(
                    LetStatement {
                        identifier: "f01" @ 4473..4476,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4482..4483,
                                        ) @ 4482..4483,
                                        Int(
                                            0,
                                        ) @ 4487..4488,
                                    ) @ 4482..4488,
                                    Equal(
                                        Identifier(
                                            "y" @ 4492..4493,
                                        ) @ 4492..4493,
                                        Int(
                                            1,
                                        ) @ 4497..4498,
                                    ) @ 4492..4498,
                                ) @ 4482..4498,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4507..4508,
                                            ) @ 4507..4508,
                                        ),
                                    ) @ 4502..4509,
                                ) @ 4499..4511,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4526..4531,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4532..4538,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4540..4546,
                                                            ) @ 4540..4546,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4548..4549,
                                                        Expression(
                                                            Int(
                                                                0,
                                                            ) @ 4551..4552,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4554..4555,
                                                        Expression(
                                                            Int(
                                                                1,
                                                            ) @ 4557..4558,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4562..4563,
                                                            Bind(
                                                                4565..4566,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4520..4567,
                                ) @ 4517..4569,
                            ),
                        ) @ 4479..4569,
                    },
                ) @ 4469..4574,
                Let(
                    LetStatement {
                        identifier: "f11" @ 4578..4581,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4587..4588,
                                        ) @ 4587..4588,
                                        Int(
                                            1,
                                        ) @ 4592..4593,
                                    ) @ 4587..4593,
                                    Equal(
                                        Identifier(
                                            "y" @ 4597..4598,
                                        ) @ 4597..4598,
                                        Int(
                                            1,
                                        ) @ 4602..4603,
                                    ) @ 4597..4603,
                                ) @ 4587..4603,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4612..4613,
                                            ) @ 4612..4613,
                                        ),
                                    ) @ 4607..4614,
                                ) @ 4604..4616,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4631..4636,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4637..4643,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4645..4651,
                                                            ) @ 4645..4651,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4653..4654,
                                                        Expression(
                                                            Int(
                                                                1,
                                                            ) @ 4656..4657,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4659..4660,
                                                        Expression(
                                                            Int(
                                                                1,
                                                            ) @ 4662..4663,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4667..4668,
                                                            Bind(
                                                                4670..4671,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4625..4672,
                                ) @ 4622..4674,
                            ),
                        ) @ 4584..4674,
                    },
                ) @ 4574..4679,
                Let(
                    LetStatement {
                        identifier: "f21" @ 4683..4686,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4692..4693,
                                        ) @ 4692..4693,
                                        Int(
                                            2,
                                        ) @ 4697..4698,
                                    ) @ 4692..4698,
                                    Equal(
                                        Identifier(
                                            "y" @ 4702..4703,
                                        ) @ 4702..4703,
                                        Int(
                                            1,
                                        ) @ 4707..4708,
                                    ) @ 4702..4708,
                                ) @ 4692..4708,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4717..4718,
                                            ) @ 4717..4718,
                                        ),
                                    ) @ 4712..4719,
                                ) @ 4709..4721,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4736..4741,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4742..4748,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4750..4756,
                                                            ) @ 4750..4756,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4758..4759,
                                                        Expression(
                                                            Int(
                                                                2,
                                                            ) @ 4761..4762,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4764..4765,
                                                        Expression(
                                                            Int(
                                                                1,
                                                            ) @ 4767..4768,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4772..4773,
                                                            Bind(
                                                                4775..4776,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4730..4777,
                                ) @ 4727..4779,
                            ),
                        ) @ 4689..4779,
                    },
                ) @ 4679..4784,
                Let(
                    LetStatement {
                        identifier: "f02" @ 4788..4791,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4797..4798,
                                        ) @ 4797..4798,
                                        Int(
                                            0,
                                        ) @ 4802..4803,
                                    ) @ 4797..4803,
                                    Equal(
                                        Identifier(
                                            "y" @ 4807..4808,
                                        ) @ 4807..4808,
                                        Int(
                                            2,
                                        ) @ 4812..4813,
                                    ) @ 4807..4813,
                                ) @ 4797..4813,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4822..4823,
                                            ) @ 4822..4823,
                                        ),
                                    ) @ 4817..4824,
                                ) @ 4814..4826,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4841..4846,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4847..4853,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4855..4861,
                                                            ) @ 4855..4861,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4863..4864,
                                                        Expression(
                                                            Int(
                                                                0,
                                                            ) @ 4866..4867,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4869..4870,
                                                        Expression(
                                                            Int(
                                                                2,
                                                            ) @ 4872..4873,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4877..4878,
                                                            Bind(
                                                                4880..4881,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4835..4882,
                                ) @ 4832..4884,
                            ),
                        ) @ 4794..4884,
                    },
                ) @ 4784..4889,
                Let(
                    LetStatement {
                        identifier: "f12" @ 4893..4896,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 4902..4903,
                                        ) @ 4902..4903,
                                        Int(
                                            1,
                                        ) @ 4907..4908,
                                    ) @ 4902..4908,
                                    Equal(
                                        Identifier(
                                            "y" @ 4912..4913,
                                        ) @ 4912..4913,
                                        Int(
                                            2,
                                        ) @ 4917..4918,
                                    ) @ 4912..4918,
                                ) @ 4902..4918,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 4927..4928,
                                            ) @ 4927..4928,
                                        ),
                                    ) @ 4922..4929,
                                ) @ 4919..4931,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 4946..4951,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 4952..4958,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 4960..4966,
                                                            ) @ 4960..4966,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 4968..4969,
                                                        Expression(
                                                            Int(
                                                                1,
                                                            ) @ 4971..4972,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 4974..4975,
                                                        Expression(
                                                            Int(
                                                                2,
                                                            ) @ 4977..4978,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 4982..4983,
                                                            Bind(
                                                                4985..4986,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 4940..4987,
                                ) @ 4937..4989,
                            ),
                        ) @ 4899..4989,
                    },
                ) @ 4889..4994,
                Let(
                    LetStatement {
                        identifier: "f22" @ 4998..5001,
                        expression: InternalFunction(
                            If(
                                And(
                                    Equal(
                                        Identifier(
                                            "x" @ 5007..5008,
                                        ) @ 5007..5008,
                                        Int(
                                            2,
                                        ) @ 5012..5013,
                                    ) @ 5007..5013,
                                    Equal(
                                        Identifier(
                                            "y" @ 5017..5018,
                                        ) @ 5017..5018,
                                        Int(
                                            2,
                                        ) @ 5022..5023,
                                    ) @ 5017..5023,
                                ) @ 5007..5023,
                                Block(
                                    [],
                                    Optional(
                                        Some(
                                            Identifier(
                                                "p" @ 5032..5033,
                                            ) @ 5032..5033,
                                        ),
                                    ) @ 5027..5034,
                                ) @ 5024..5036,
                                Block(
                                    [],
                                    InternalFunction(
                                        Query(
                                            FactLiteral {
                                                identifier: "Field" @ 5051..5056,
                                                key_fields: [
                                                    (
                                                        "gameID" @ 5057..5063,
                                                        Expression(
                                                            Identifier(
                                                                "gameID" @ 5065..5071,
                                                            ) @ 5065..5071,
                                                        ),
                                                    ),
                                                    (
                                                        "x" @ 5073..5074,
                                                        Expression(
                                                            Int(
                                                                2,
                                                            ) @ 5076..5077,
                                                        ),
                                                    ),
                                                    (
                                                        "y" @ 5079..5080,
                                                        Expression(
                                                            Int(
                                                                2,
                                                            ) @ 5082..5083,
                                                        ),
                                                    ),
                                                ],
                                                value_fields: Some(
                                                    [
                                                        (
                                                            "p" @ 5087..5088,
                                                            Bind(
                                                                5090..5091,
                                                            ),
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                    ) @ 5045..5092,
                                ) @ 5042..5094,
                            ),
                        ) @ 5004..5094,
                    },
                ) @ 4994..5099,
                Return(
                    ReturnStatement {
                        expression: Or(
                            Or(
                                Or(
                                    Or(
                                        Or(
                                            Or(
                                                Or(
                                                    And(
                                                        And(
                                                            Is(
                                                                Identifier(
                                                                    "f00" @ 5107..5110,
                                                                ) @ 5107..5110,
                                                                true,
                                                            ) @ 5107..5118,
                                                            Equal(
                                                                Identifier(
                                                                    "f00" @ 5122..5125,
                                                                ) @ 5122..5125,
                                                                Identifier(
                                                                    "f10" @ 5129..5132,
                                                                ) @ 5129..5132,
                                                            ) @ 5122..5132,
                                                        ) @ 5107..5132,
                                                        Equal(
                                                            Identifier(
                                                                "f10" @ 5136..5139,
                                                            ) @ 5136..5139,
                                                            Identifier(
                                                                "f20" @ 5143..5146,
                                                            ) @ 5143..5146,
                                                        ) @ 5136..5146,
                                                    ) @ 5107..5146,
                                                    And(
                                                        And(
                                                            Is(
                                                                Identifier(
                                                                    "f01" @ 5163..5166,
                                                                ) @ 5163..5166,
                                                                true,
                                                            ) @ 5163..5174,
                                                            Equal(
                                                                Identifier(
                                                                    "f01" @ 5178..5181,
                                                                ) @ 5178..5181,
                                                                Identifier(
                                                                    "f11" @ 5185..5188,
                                                                ) @ 5185..5188,
                                                            ) @ 5178..5188,
                                                        ) @ 5163..5188,
                                                        Equal(
                                                            Identifier(
                                                                "f11" @ 5192..5195,
                                                            ) @ 5192..5195,
                                                            Identifier(
                                                                "f21" @ 5199..5202,
                                                            ) @ 5199..5202,
                                                        ) @ 5192..5202,
                                                    ) @ 5163..5202,
                                                ) @ 5107..5202,
                                                And(
                                                    And(
                                                        Is(
                                                            Identifier(
                                                                "f01" @ 5219..5222,
                                                            ) @ 5219..5222,
                                                            true,
                                                        ) @ 5219..5230,
                                                        Equal(
                                                            Identifier(
                                                                "f02" @ 5234..5237,
                                                            ) @ 5234..5237,
                                                            Identifier(
                                                                "f12" @ 5241..5244,
                                                            ) @ 5241..5244,
                                                        ) @ 5234..5244,
                                                    ) @ 5219..5244,
                                                    Equal(
                                                        Identifier(
                                                            "f12" @ 5248..5251,
                                                        ) @ 5248..5251,
                                                        Identifier(
                                                            "f22" @ 5255..5258,
                                                        ) @ 5255..5258,
                                                    ) @ 5248..5258,
                                                ) @ 5219..5258,
                                            ) @ 5107..5258,
                                            And(
                                                And(
                                                    Is(
                                                        Identifier(
                                                            "f00" @ 5275..5278,
                                                        ) @ 5275..5278,
                                                        true,
                                                    ) @ 5275..5286,
                                                    Equal(
                                                        Identifier(
                                                            "f00" @ 5290..5293,
                                                        ) @ 5290..5293,
                                                        Identifier(
                                                            "f01" @ 5297..5300,
                                                        ) @ 5297..5300,
                                                    ) @ 5290..5300,
                                                ) @ 5275..5300,
                                                Equal(
                                                    Identifier(
                                                        "f01" @ 5304..5307,
                                                    ) @ 5304..5307,
                                                    Identifier(
                                                        "f02" @ 5311..5314,
                                                    ) @ 5311..5314,
                                                ) @ 5304..5314,
                                            ) @ 5275..5314,
                                        ) @ 5107..5314,
                                        And(
                                            And(
                                                Is(
                                                    Identifier(
                                                        "f10" @ 5331..5334,
                                                    ) @ 5331..5334,
                                                    true,
                                                ) @ 5331..5342,
                                                Equal(
                                                    Identifier(
                                                        "f10" @ 5346..5349,
                                                    ) @ 5346..5349,
                                                    Identifier(
                                                        "f11" @ 5353..5356,
                                                    ) @ 5353..5356,
                                                ) @ 5346..5356,
                                            ) @ 5331..5356,
                                            Equal(
                                                Identifier(
                                                    "f11" @ 5360..5363,
                                                ) @ 5360..5363,
                                                Identifier(
                                                    "f12" @ 5367..5370,
                                                ) @ 5367..5370,
                                            ) @ 5360..5370,
                                        ) @ 5331..5370,
                                    ) @ 5107..5370,
                                    And(
                                        And(
                                            Is(
                                                Identifier(
                                                    "f20" @ 5387..5390,
                                                ) @ 5387..5390,
                                                true,
                                            ) @ 5387..5398,
                                            Equal(
                                                Identifier(
                                                    "f20" @ 5402..5405,
                                                ) @ 5402..5405,
                                                Identifier(
                                                    "f21" @ 5409..5412,
                                                ) @ 5409..5412,
                                            ) @ 5402..5412,
                                        ) @ 5387..5412,
                                        Equal(
                                            Identifier(
                                                "f21" @ 5416..5419,
                                            ) @ 5416..5419,
                                            Identifier(
                                                "f22" @ 5423..5426,
                                            ) @ 5423..5426,
                                        ) @ 5416..5426,
                                    ) @ 5387..5426,
                                ) @ 5107..5426,
                                And(
                                    And(
                                        Is(
                                            Identifier(
                                                "f00" @ 5443..5446,
                                            ) @ 5443..5446,
                                            true,
                                        ) @ 5443..5454,
                                        Equal(
                                            Identifier(
                                                "f00" @ 5458..5461,
                                            ) @ 5458..5461,
                                            Identifier(
                                                "f11" @ 5465..5468,
                                            ) @ 5465..5468,
                                        ) @ 5458..5468,
                                    ) @ 5443..5468,
                                    Equal(
                                        Identifier(
                                            "f11" @ 5472..5475,
                                        ) @ 5472..5475,
                                        Identifier(
                                            "f22" @ 5479..5482,
                                        ) @ 5479..5482,
                                    ) @ 5472..5482,
                                ) @ 5443..5482,
                            ) @ 5107..5482,
                            And(
                                And(
                                    Is(
                                        Identifier(
                                            "f20" @ 5499..5502,
                                        ) @ 5499..5502,
                                        true,
                                    ) @ 5499..5510,
                                    Equal(
                                        Identifier(
                                            "f20" @ 5514..5517,
                                        ) @ 5514..5517,
                                        Identifier(
                                            "f11" @ 5521..5524,
                                        ) @ 5521..5524,
                                    ) @ 5514..5524,
                                ) @ 5499..5524,
                                Equal(
                                    Identifier(
                                        "f11" @ 5528..5531,
                                    ) @ 5528..5531,
                                    Identifier(
                                        "f02" @ 5535..5538,
                                    ) @ 5535..5538,
                                ) @ 5528..5538,
                            ) @ 5499..5538,
                        ) @ 5107..5538,
                    },
                ) @ 5099..5540,
            ],
            span: 4089..5541,
        },
    ],
    finish_functions: [
        FinishFunctionDefinition {
            identifier: "set_next_player" @ 498..513,
            arguments: [
                Param {
                    name: "gameID" @ 514..520,
                    ty: Id @ 521..523,
                },
                Param {
                    name: "to_input" @ 525..533,
                    ty: String @ 534..540,
                },
            ],
            statements: [
                Update(
                    UpdateStatement {
                        fact: FactLiteral {
                            identifier: "NextPlayer" @ 555..565,
                            key_fields: [
                                (
                                    "gameID" @ 566..572,
                                    Expression(
                                        Identifier(
                                            "gameID" @ 574..580,
                                        ) @ 574..580,
                                    ),
                                ),
                            ],
                            value_fields: None,
                        },
                        to: [
                            (
                                "p" @ 586..587,
                                Expression(
                                    Identifier(
                                        "to_input" @ 589..597,
                                    ) @ 589..597,
                                ),
                            ),
                        ],
                    },
                ) @ 548..598,
            ],
            span: 482..600,
        },
    ],
    global_lets: [],
    text: "---\npolicy-version: 2\n---\n\n```policy\nfact Players[gameID id]=>{x id, o id}\nfact NextPlayer[gameID id]=>{p string}\nfact Field[gameID id, x int, y int]=>{p string}\nfact GameOver[gameID id]=>{}\n\n// Regular functions can only contain data processing statements, must\n// have a return type, and must return a value\nfunction bounds(v int) bool {\n    return v >= 0 && v <= 2\n}\n// finish functions can only be used in finish blocks and can only contain\n// statements valid in finish blocks\nfinish function set_next_player(gameID id, to_input string) {\n    update NextPlayer[gameID: gameID] to {p: to_input}\n}\n\naction StartGame(profileX id, profileO id) {\n    let start_command = Start{\n        ProfileX: profileX,\n        ProfileO: profileO,\n    }\n    publish start_command\n}\n\neffect GameStart {\n    gameID id,\n    x id,\n    o id,\n}\n\ncommand Start {\n    fields {\n        ProfileX id,\n        ProfileO id,\n    }\n\n    policy {\n        check ProfileX != ProfileO\n        // `envelope::command_id` is an FFI-provided helper function that returns\n        // the ID from the passed in `envelope`.\n        let gameID = envelope::command_id(envelope)\n        finish {\n            create PlayerProfile[gameID: gameID]=>{x: ProfileX, o: ProfileO}\n            create NextPlayer[gameID: gameID]=>{p: \"X\"}\n\n            emit GameStart{\n                gameID: gameID,\n                x: ProfileX,\n                o: ProfileO,\n            }\n        }\n    }\n}\n\naction MakeMove(gameID id, x int, y int) {\n    let move_command = Move {\n        gameID: gameID,\n        X: x,\n        Y: y,\n    }\n    publish move_command\n}\n\neffect GameUpdate {\n    gameID id,\n    player id,\n    // the \"dynamic\" keyword is an annotation used to indicate to the consumer\n    // that this value is not based on static event data and may change.\n    p      string dynamic,\n    X      int,\n    Y      int,\n}\n\neffect GameOver {\n    gameID id,\n    winner id,\n    p string,\n}\n\ncommand Move {\n    // phase 0: command field definition\n    fields {\n        gameID id,\n        X int,\n        Y int,\n    }\n\n    policy {\n        // phase 1: variable definition/checks\n        // These aren't \"variables\" in the procedural sense, they are\n        // set-once constant definitions that can be used in later\n        // expressions.\n        // `envelope::author_id` is an FFI-provided helper function which\n        // returns the ID for the author of the command from the passed in\n        // `envelope`.\n        let player = envelope::author_id(envelope)\n        // the query expression searches the fact database for facts which\n        // match the signature, returning an Optional containing either all\n        // values marked with ?, or None. The unwrap expression returns the\n        // value inside an Optional or terminates rule execution.\n        let result = unwrap query PlayerProfile[gameID: gameID]=>{x: ?, o: ?}\n        let playerX = result.x\n        let playerO = result.o\n        let p = unwrap query NextPlayer[gameID: gameID]=>{p: ?}\n        // the if expression works like a ternary expression, where both\n        // branches must be specified.\n        let nextp = if p == \"X\" { :\"O\" } else { :\"X\" }\n\n        // Checks are separated here, but they can be interleaved with let\n        // statements.\n        // Defined variables, command fields, and common event fields can\n        // be checked for validity with boolean expressions.\n        check (p == \"X\" && player == playerX) || (p == \"O\" && player == playerO)\n        // functions can be used in any expression\n        check bounds(X)\n        check bounds(Y)\n\n        // phase 2: fact updates and effects\n        // Facts can be created, updated, and destroyed.\n        // Zero or more effects can be generated.\n        // The finish block ends rule evaluation.\n        finish {\n            create Field[gameID: gameID, x: X, y: Y]=>{p: p}\n            set_next_player(gameID, nextp)\n\n            emit GameUpdate{\n                gameID: gameID,\n                player: player,\n                p: p,\n                X: X,\n                Y: Y,\n            }\n        }\n    }\n}\n\nfunction game_over(gameID id, x int, y int, p string) bool {\n    let f00 = if x == 0 && y == 0 { :Some(p) } else { :query Field[gameID: gameID, x: 0, y: 0]=>{p: ?} }\n    let f10 = if x == 1 && y == 0 { :Some(p) } else { :query Field[gameID: gameID, x: 1, y: 0]=>{p: ?} }\n    let f20 = if x == 2 && y == 0 { :Some(p) } else { :query Field[gameID: gameID, x: 2, y: 0]=>{p: ?} }\n    let f01 = if x == 0 && y == 1 { :Some(p) } else { :query Field[gameID: gameID, x: 0, y: 1]=>{p: ?} }\n    let f11 = if x == 1 && y == 1 { :Some(p) } else { :query Field[gameID: gameID, x: 1, y: 1]=>{p: ?} }\n    let f21 = if x == 2 && y == 1 { :Some(p) } else { :query Field[gameID: gameID, x: 2, y: 1]=>{p: ?} }\n    let f02 = if x == 0 && y == 2 { :Some(p) } else { :query Field[gameID: gameID, x: 0, y: 2]=>{p: ?} }\n    let f12 = if x == 1 && y == 2 { :Some(p) } else { :query Field[gameID: gameID, x: 1, y: 2]=>{p: ?} }\n    let f22 = if x == 2 && y == 2 { :Some(p) } else { :query Field[gameID: gameID, x: 2, y: 2]=>{p: ?} }\n    return (f00 is Some && f00 == f10 && f10 == f20) ||\n           (f01 is Some && f01 == f11 && f11 == f21) ||\n           (f01 is Some && f02 == f12 && f12 == f22) ||\n           (f00 is Some && f00 == f01 && f01 == f02) ||\n           (f10 is Some && f10 == f11 && f11 == f12) ||\n           (f20 is Some && f20 == f21 && f21 == f22) ||\n           (f00 is Some && f00 == f11 && f11 == f22) ||\n           (f20 is Some && f20 == f11 && f11 == f02)\n}\n\ncommand Move2 {\n    fields {\n        gameID id,\n        X int,\n        Y int,\n    }\n\n    policy {\n        let player = envelope::author_id(envelope)\n        let players = unwrap query PlayerProfile[gameID: gameID]=>{x: ?, o: ?}\n        let p = unwrap query NextPlayer[gameID: gameID]=>{p: ?}\n        let nextp = if p == \"X\" { :\"O\" } else { :\"X\" }\n\n        check !exists GameOver[gameID: gameID]=>{}\n        check bounds(X)\n        check bounds(Y)\n        check (p == \"X\" && player == players.x) || (p == \"O\" && player == players.o)\n\n        match game_over(gameID, X, Y, p) {\n            true => {\n                finish {\n                    create Field[gameID: gameID, x: X, y: Y]=>{p: p}\n                    delete NextPlayer[gameID: gameID]=>{p: p}\n                    create GameOver[gameID: gameID]=>{}\n                    emit GameOver{\n                        gameID: gameID,\n                        winner: player,\n                        p: p,\n                    }\n                }\n            }\n            false => {\n                finish {\n                    create Field[gameID: gameID, x: X, y: Y]=>{p: p}\n                    set_next_player(gameID, op)\n                    emit GameUpdate{\n                        gameID: gameID,\n                        player: player,\n                        p: p,\n                        x: X,\n                        y: Y,\n                    }\n                }\n            }\n        }\n    }\n}\n```\n",
}
