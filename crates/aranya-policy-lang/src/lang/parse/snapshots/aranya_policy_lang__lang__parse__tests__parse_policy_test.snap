---
source: crates/aranya-policy-lang/src/lang/parse/tests.rs
expression: policy
---
Policy {
    version: V2,
    ffi_imports: [],
    facts: [
        FactDefinition {
            immutable: false,
            identifier: Ident {
                name: "F",
                span: 150..151,
            },
            key: [
                FieldDefinition {
                    identifier: Ident {
                        name: "v",
                        span: 152..153,
                    },
                    field_type: VType {
                        kind: String,
                        span: 154..160,
                    },
                },
            ],
            value: [
                FieldDefinition {
                    identifier: Ident {
                        name: "x",
                        span: 164..165,
                    },
                    field_type: VType {
                        kind: Int,
                        span: 166..169,
                    },
                },
                FieldDefinition {
                    identifier: Ident {
                        name: "y",
                        span: 171..172,
                    },
                    field_type: VType {
                        kind: Bool,
                        span: 173..177,
                    },
                },
            ],
            span: 145..178,
        },
    ],
    actions: [
        ActionDefinition {
            persistence: Persistent,
            identifier: Ident {
                name: "add2",
                span: 195..199,
            },
            arguments: [
                FieldDefinition {
                    identifier: Ident {
                        name: "x",
                        span: 200..201,
                    },
                    field_type: VType {
                        kind: Int,
                        span: 202..205,
                    },
                },
                FieldDefinition {
                    identifier: Ident {
                        name: "y",
                        span: 207..208,
                    },
                    field_type: VType {
                        kind: Int,
                        span: 209..212,
                    },
                },
            ],
            statements: [
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "obj",
                                span: 232..235,
                            },
                            expression: Expression {
                                kind: NamedStruct(
                                    NamedStruct {
                                        identifier: Ident {
                                            name: "Add",
                                            span: 238..241,
                                        },
                                        fields: [
                                            (
                                                Ident {
                                                    name: "count",
                                                    span: 260..265,
                                                },
                                                Expression {
                                                    kind: Identifier(
                                                        Ident {
                                                            name: "x",
                                                            span: 267..268,
                                                        },
                                                    ),
                                                    span: 267..268,
                                                },
                                            ),
                                        ],
                                        sources: [],
                                    },
                                ),
                                span: 238..283,
                            },
                        },
                    ),
                    span: 228..296,
                },
                Statement {
                    kind: Publish(
                        Expression {
                            kind: Identifier(
                                Ident {
                                    name: "obj",
                                    span: 304..307,
                                },
                            ),
                            span: 304..307,
                        },
                    ),
                    span: 296..316,
                },
            ],
            span: 188..317,
        },
        ActionDefinition {
            persistence: Ephemeral(
                2378..2387,
            ),
            identifier: Ident {
                name: "a",
                span: 2395..2396,
            },
            arguments: [],
            statements: [],
            span: 2378..2401,
        },
    ],
    effects: [
        EffectDefinition {
            identifier: Ident {
                name: "Added",
                span: 334..339,
            },
            items: [
                Field(
                    EffectFieldDefinition {
                        identifier: Ident {
                            name: "x",
                            span: 354..355,
                        },
                        field_type: VType {
                            kind: Int,
                            span: 356..359,
                        },
                        dynamic: true,
                    },
                ),
                Field(
                    EffectFieldDefinition {
                        identifier: Ident {
                            name: "y",
                            span: 381..382,
                        },
                        field_type: VType {
                            kind: Int,
                            span: 383..386,
                        },
                        dynamic: false,
                    },
                ),
            ],
            span: 327..397,
        },
    ],
    structs: [],
    enums: [],
    commands: [
        CommandDefinition {
            persistence: Persistent,
            attributes: [],
            identifier: Ident {
                name: "Add",
                span: 415..418,
            },
            fields: [
                Field(
                    FieldDefinition {
                        identifier: Ident {
                            name: "count",
                            span: 458..463,
                        },
                        field_type: VType {
                            kind: Int,
                            span: 464..467,
                        },
                    },
                ),
            ],
            seal: [],
            open: [],
            policy: [
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "envelope_id",
                                span: 524..535,
                            },
                            expression: Expression {
                                kind: ForeignFunctionCall(
                                    ForeignFunctionCall {
                                        module: Ident {
                                            name: "envelope",
                                            span: 538..546,
                                        },
                                        identifier: Ident {
                                            name: "command_id",
                                            span: 548..558,
                                        },
                                        arguments: [
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "envelope",
                                                        span: 559..567,
                                                    },
                                                ),
                                                span: 559..567,
                                            },
                                        ],
                                    },
                                ),
                                span: 538..568,
                            },
                        },
                    ),
                    span: 520..585,
                },
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "author",
                                span: 589..595,
                            },
                            expression: Expression {
                                kind: ForeignFunctionCall(
                                    ForeignFunctionCall {
                                        module: Ident {
                                            name: "envelope",
                                            span: 598..606,
                                        },
                                        identifier: Ident {
                                            name: "author_id",
                                            span: 608..617,
                                        },
                                        arguments: [
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "envelope",
                                                        span: 618..626,
                                                    },
                                                ),
                                                span: 618..626,
                                            },
                                        ],
                                    },
                                ),
                                span: 598..627,
                            },
                        },
                    ),
                    span: 585..644,
                },
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "new_x",
                                span: 648..653,
                            },
                            expression: Expression {
                                kind: FunctionCall(
                                    FunctionCall {
                                        identifier: Ident {
                                            name: "add2",
                                            span: 656..660,
                                        },
                                        arguments: [
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "x",
                                                        span: 661..662,
                                                    },
                                                ),
                                                span: 661..662,
                                            },
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "count",
                                                        span: 664..669,
                                                    },
                                                ),
                                                span: 664..669,
                                            },
                                        ],
                                    },
                                ),
                                span: 656..670,
                            },
                        },
                    ),
                    span: 644..687,
                },
                Statement {
                    kind: Check(
                        CheckStatement {
                            expression: Expression {
                                kind: InternalFunction(
                                    Exists(
                                        FactLiteral {
                                            identifier: Ident {
                                                name: "TestFact",
                                                span: 700..708,
                                            },
                                            key_fields: [
                                                (
                                                    Ident {
                                                        name: "v",
                                                        span: 709..710,
                                                    },
                                                    Expression(
                                                        Expression {
                                                            kind: String(
                                                                "test",
                                                            ),
                                                            span: 712..718,
                                                        },
                                                    ),
                                                ),
                                            ],
                                            value_fields: Some(
                                                [],
                                            ),
                                        },
                                    ),
                                ),
                                span: 693..723,
                            },
                        },
                    ),
                    span: 687..740,
                },
                Statement {
                    kind: Match(
                        MatchStatement {
                            expression: Expression {
                                kind: Identifier(
                                    Ident {
                                        name: "x",
                                        span: 746..747,
                                    },
                                ),
                                span: 746..747,
                            },
                            arms: [
                                MatchArm {
                                    pattern: Values(
                                        [
                                            Expression {
                                                kind: Int(
                                                    0,
                                                ),
                                                span: 770..771,
                                            },
                                        ],
                                    ),
                                    statements: [
                                        Statement {
                                            kind: Check(
                                                CheckStatement {
                                                    expression: Expression {
                                                        kind: FunctionCall(
                                                            FunctionCall {
                                                                identifier: Ident {
                                                                    name: "positive",
                                                                    span: 807..815,
                                                                },
                                                                arguments: [
                                                                    Expression {
                                                                        kind: Optional(
                                                                            Some(
                                                                                Expression {
                                                                                    kind: Identifier(
                                                                                        Ident {
                                                                                            name: "new_x",
                                                                                            span: 821..826,
                                                                                        },
                                                                                    ),
                                                                                    span: 821..826,
                                                                                },
                                                                            ),
                                                                        ),
                                                                        span: 816..827,
                                                                    },
                                                                ],
                                                            },
                                                        ),
                                                        span: 807..828,
                                                    },
                                                },
                                            ),
                                            span: 801..849,
                                        },
                                    ],
                                },
                                MatchArm {
                                    pattern: Values(
                                        [
                                            Expression {
                                                kind: Int(
                                                    1,
                                                ),
                                                span: 871..872,
                                            },
                                        ],
                                    ),
                                    statements: [
                                        Statement {
                                            kind: Check(
                                                CheckStatement {
                                                    expression: Expression {
                                                        kind: FunctionCall(
                                                            FunctionCall {
                                                                identifier: Ident {
                                                                    name: "positive",
                                                                    span: 908..916,
                                                                },
                                                                arguments: [
                                                                    Expression {
                                                                        kind: Optional(
                                                                            None,
                                                                        ),
                                                                        span: 917..921,
                                                                    },
                                                                ],
                                                            },
                                                        ),
                                                        span: 908..922,
                                                    },
                                                },
                                            ),
                                            span: 902..943,
                                        },
                                    ],
                                },
                                MatchArm {
                                    pattern: Default(
                                        965..966,
                                    ),
                                    statements: [],
                                },
                            ],
                        },
                    ),
                    span: 740..1012,
                },
                Statement {
                    kind: If(
                        IfStatement {
                            branches: [
                                (
                                    Expression {
                                        kind: Equal(
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "x",
                                                        span: 1033..1034,
                                                    },
                                                ),
                                                span: 1033..1034,
                                            },
                                            Expression {
                                                kind: Int(
                                                    3,
                                                ),
                                                span: 1038..1039,
                                            },
                                        ),
                                        span: 1033..1039,
                                    },
                                    [
                                        Statement {
                                            kind: Check(
                                                CheckStatement {
                                                    expression: Expression {
                                                        kind: LessThan(
                                                            Expression {
                                                                kind: Identifier(
                                                                    Ident {
                                                                        name: "new_x",
                                                                        span: 1068..1073,
                                                                    },
                                                                ),
                                                                span: 1068..1073,
                                                            },
                                                            Expression {
                                                                kind: Int(
                                                                    10,
                                                                ),
                                                                span: 1076..1078,
                                                            },
                                                        ),
                                                        span: 1068..1078,
                                                    },
                                                },
                                            ),
                                            span: 1062..1095,
                                        },
                                    ],
                                ),
                            ],
                            fallback: None,
                        },
                    ),
                    span: 1030..1114,
                },
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "a",
                                span: 1118..1119,
                            },
                            expression: Expression {
                                kind: ForeignFunctionCall(
                                    ForeignFunctionCall {
                                        module: Ident {
                                            name: "foo",
                                            span: 1122..1125,
                                        },
                                        identifier: Ident {
                                            name: "ext_func",
                                            span: 1127..1135,
                                        },
                                        arguments: [
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "x",
                                                        span: 1136..1137,
                                                    },
                                                ),
                                                span: 1136..1137,
                                            },
                                        ],
                                    },
                                ),
                                span: 1122..1138,
                            },
                        },
                    ),
                    span: 1114..1156,
                },
                Statement {
                    kind: Finish(
                        [
                            Statement {
                                kind: Create(
                                    CreateStatement {
                                        fact: FactLiteral {
                                            identifier: Ident {
                                                name: "F",
                                                span: 1192..1193,
                                            },
                                            key_fields: [
                                                (
                                                    Ident {
                                                        name: "v",
                                                        span: 1194..1195,
                                                    },
                                                    Expression(
                                                        Expression {
                                                            kind: String(
                                                                "hello",
                                                            ),
                                                            span: 1197..1204,
                                                        },
                                                    ),
                                                ),
                                            ],
                                            value_fields: Some(
                                                [
                                                    (
                                                        Ident {
                                                            name: "x",
                                                            span: 1208..1209,
                                                        },
                                                        Expression(
                                                            Expression {
                                                                kind: Identifier(
                                                                    Ident {
                                                                        name: "x",
                                                                        span: 1211..1212,
                                                                    },
                                                                ),
                                                                span: 1211..1212,
                                                            },
                                                        ),
                                                    ),
                                                    (
                                                        Ident {
                                                            name: "y",
                                                            span: 1214..1215,
                                                        },
                                                        Expression(
                                                            Expression {
                                                                kind: FunctionCall(
                                                                    FunctionCall {
                                                                        identifier: Ident {
                                                                            name: "saturating_sub",
                                                                            span: 1217..1231,
                                                                        },
                                                                        arguments: [
                                                                            Expression {
                                                                                kind: Int(
                                                                                    0,
                                                                                ),
                                                                                span: 1232..1233,
                                                                            },
                                                                            Expression {
                                                                                kind: Identifier(
                                                                                    Ident {
                                                                                        name: "x",
                                                                                        span: 1235..1236,
                                                                                    },
                                                                                ),
                                                                                span: 1235..1236,
                                                                            },
                                                                        ],
                                                                    },
                                                                ),
                                                                span: 1217..1237,
                                                            },
                                                        ),
                                                    ),
                                                ],
                                            ),
                                        },
                                    },
                                ),
                                span: 1185..1238,
                            },
                            Statement {
                                kind: Update(
                                    UpdateStatement {
                                        fact: FactLiteral {
                                            identifier: Ident {
                                                name: "F",
                                                span: 1266..1267,
                                            },
                                            key_fields: [],
                                            value_fields: Some(
                                                [
                                                    (
                                                        Ident {
                                                            name: "x",
                                                            span: 1272..1273,
                                                        },
                                                        Expression(
                                                            Expression {
                                                                kind: Identifier(
                                                                    Ident {
                                                                        name: "x",
                                                                        span: 1275..1276,
                                                                    },
                                                                ),
                                                                span: 1275..1276,
                                                            },
                                                        ),
                                                    ),
                                                ],
                                            ),
                                        },
                                        to: [
                                            (
                                                Ident {
                                                    name: "x",
                                                    span: 1282..1283,
                                                },
                                                Expression(
                                                    Expression {
                                                        kind: Identifier(
                                                            Ident {
                                                                name: "new_x",
                                                                span: 1285..1290,
                                                            },
                                                        ),
                                                        span: 1285..1290,
                                                    },
                                                ),
                                            ),
                                        ],
                                    },
                                ),
                                span: 1259..1291,
                            },
                            Statement {
                                kind: Delete(
                                    DeleteStatement {
                                        fact: FactLiteral {
                                            identifier: Ident {
                                                name: "F",
                                                span: 1319..1320,
                                            },
                                            key_fields: [
                                                (
                                                    Ident {
                                                        name: "v",
                                                        span: 1321..1322,
                                                    },
                                                    Expression(
                                                        Expression {
                                                            kind: String(
                                                                "hello",
                                                            ),
                                                            span: 1324..1331,
                                                        },
                                                    ),
                                                ),
                                            ],
                                            value_fields: None,
                                        },
                                    },
                                ),
                                span: 1312..1353,
                            },
                            Statement {
                                kind: Emit(
                                    Expression {
                                        kind: NamedStruct(
                                            NamedStruct {
                                                identifier: Ident {
                                                    name: "Added",
                                                    span: 1358..1363,
                                                },
                                                fields: [
                                                    (
                                                        Ident {
                                                            name: "x",
                                                            span: 1390..1391,
                                                        },
                                                        Expression {
                                                            kind: Identifier(
                                                                Ident {
                                                                    name: "new_x",
                                                                    span: 1393..1398,
                                                                },
                                                            ),
                                                            span: 1393..1398,
                                                        },
                                                    ),
                                                    (
                                                        Ident {
                                                            name: "y",
                                                            span: 1424..1425,
                                                        },
                                                        Expression {
                                                            kind: Identifier(
                                                                Ident {
                                                                    name: "count",
                                                                    span: 1427..1432,
                                                                },
                                                            ),
                                                            span: 1427..1432,
                                                        },
                                                    ),
                                                ],
                                                sources: [],
                                            },
                                        ),
                                        span: 1358..1455,
                                    },
                                ),
                                span: 1353..1472,
                            },
                        ],
                    ),
                    span: 1156..1473,
                },
            ],
            recall: [
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "envelope_id",
                                span: 1529..1540,
                            },
                            expression: Expression {
                                kind: ForeignFunctionCall(
                                    ForeignFunctionCall {
                                        module: Ident {
                                            name: "envelope",
                                            span: 1543..1551,
                                        },
                                        identifier: Ident {
                                            name: "command_id",
                                            span: 1553..1563,
                                        },
                                        arguments: [
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "envelope",
                                                        span: 1564..1572,
                                                    },
                                                ),
                                                span: 1564..1572,
                                            },
                                        ],
                                    },
                                ),
                                span: 1543..1573,
                            },
                        },
                    ),
                    span: 1525..1590,
                },
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "author",
                                span: 1594..1600,
                            },
                            expression: Expression {
                                kind: ForeignFunctionCall(
                                    ForeignFunctionCall {
                                        module: Ident {
                                            name: "envelope",
                                            span: 1603..1611,
                                        },
                                        identifier: Ident {
                                            name: "author_id",
                                            span: 1613..1622,
                                        },
                                        arguments: [
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "envelope",
                                                        span: 1623..1631,
                                                    },
                                                ),
                                                span: 1623..1631,
                                            },
                                        ],
                                    },
                                ),
                                span: 1603..1632,
                            },
                        },
                    ),
                    span: 1590..1649,
                },
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "new_x",
                                span: 1653..1658,
                            },
                            expression: Expression {
                                kind: FunctionCall(
                                    FunctionCall {
                                        identifier: Ident {
                                            name: "add2",
                                            span: 1661..1665,
                                        },
                                        arguments: [
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "x",
                                                        span: 1666..1667,
                                                    },
                                                ),
                                                span: 1666..1667,
                                            },
                                            Expression {
                                                kind: Identifier(
                                                    Ident {
                                                        name: "count",
                                                        span: 1669..1674,
                                                    },
                                                ),
                                                span: 1669..1674,
                                            },
                                        ],
                                    },
                                ),
                                span: 1661..1675,
                            },
                        },
                    ),
                    span: 1649..1692,
                },
                Statement {
                    kind: Finish(
                        [
                            Statement {
                                kind: Create(
                                    CreateStatement {
                                        fact: FactLiteral {
                                            identifier: Ident {
                                                name: "F",
                                                span: 1728..1729,
                                            },
                                            key_fields: [
                                                (
                                                    Ident {
                                                        name: "v",
                                                        span: 1730..1731,
                                                    },
                                                    Expression(
                                                        Expression {
                                                            kind: String(
                                                                "hello",
                                                            ),
                                                            span: 1733..1740,
                                                        },
                                                    ),
                                                ),
                                            ],
                                            value_fields: Some(
                                                [
                                                    (
                                                        Ident {
                                                            name: "x",
                                                            span: 1744..1745,
                                                        },
                                                        Expression(
                                                            Expression {
                                                                kind: Identifier(
                                                                    Ident {
                                                                        name: "x",
                                                                        span: 1747..1748,
                                                                    },
                                                                ),
                                                                span: 1747..1748,
                                                            },
                                                        ),
                                                    ),
                                                    (
                                                        Ident {
                                                            name: "y",
                                                            span: 1750..1751,
                                                        },
                                                        Expression(
                                                            Expression {
                                                                kind: FunctionCall(
                                                                    FunctionCall {
                                                                        identifier: Ident {
                                                                            name: "saturating_sub",
                                                                            span: 1753..1767,
                                                                        },
                                                                        arguments: [
                                                                            Expression {
                                                                                kind: Int(
                                                                                    0,
                                                                                ),
                                                                                span: 1768..1769,
                                                                            },
                                                                            Expression {
                                                                                kind: Identifier(
                                                                                    Ident {
                                                                                        name: "x",
                                                                                        span: 1771..1772,
                                                                                    },
                                                                                ),
                                                                                span: 1771..1772,
                                                                            },
                                                                        ],
                                                                    },
                                                                ),
                                                                span: 1753..1773,
                                                            },
                                                        ),
                                                    ),
                                                ],
                                            ),
                                        },
                                    },
                                ),
                                span: 1721..1774,
                            },
                            Statement {
                                kind: Update(
                                    UpdateStatement {
                                        fact: FactLiteral {
                                            identifier: Ident {
                                                name: "F",
                                                span: 1802..1803,
                                            },
                                            key_fields: [],
                                            value_fields: Some(
                                                [
                                                    (
                                                        Ident {
                                                            name: "x",
                                                            span: 1808..1809,
                                                        },
                                                        Expression(
                                                            Expression {
                                                                kind: Identifier(
                                                                    Ident {
                                                                        name: "x",
                                                                        span: 1811..1812,
                                                                    },
                                                                ),
                                                                span: 1811..1812,
                                                            },
                                                        ),
                                                    ),
                                                ],
                                            ),
                                        },
                                        to: [
                                            (
                                                Ident {
                                                    name: "x",
                                                    span: 1818..1819,
                                                },
                                                Expression(
                                                    Expression {
                                                        kind: Identifier(
                                                            Ident {
                                                                name: "new_x",
                                                                span: 1821..1826,
                                                            },
                                                        ),
                                                        span: 1821..1826,
                                                    },
                                                ),
                                            ),
                                        ],
                                    },
                                ),
                                span: 1795..1827,
                            },
                            Statement {
                                kind: Delete(
                                    DeleteStatement {
                                        fact: FactLiteral {
                                            identifier: Ident {
                                                name: "F",
                                                span: 1855..1856,
                                            },
                                            key_fields: [
                                                (
                                                    Ident {
                                                        name: "v",
                                                        span: 1857..1858,
                                                    },
                                                    Expression(
                                                        Expression {
                                                            kind: String(
                                                                "hello",
                                                            ),
                                                            span: 1860..1867,
                                                        },
                                                    ),
                                                ),
                                            ],
                                            value_fields: None,
                                        },
                                    },
                                ),
                                span: 1848..1889,
                            },
                            Statement {
                                kind: Emit(
                                    Expression {
                                        kind: NamedStruct(
                                            NamedStruct {
                                                identifier: Ident {
                                                    name: "Added",
                                                    span: 1894..1899,
                                                },
                                                fields: [
                                                    (
                                                        Ident {
                                                            name: "x",
                                                            span: 1926..1927,
                                                        },
                                                        Expression {
                                                            kind: Identifier(
                                                                Ident {
                                                                    name: "new_x",
                                                                    span: 1929..1934,
                                                                },
                                                            ),
                                                            span: 1929..1934,
                                                        },
                                                    ),
                                                    (
                                                        Ident {
                                                            name: "y",
                                                            span: 1960..1961,
                                                        },
                                                        Expression {
                                                            kind: Identifier(
                                                                Ident {
                                                                    name: "count",
                                                                    span: 1963..1968,
                                                                },
                                                            ),
                                                            span: 1963..1968,
                                                        },
                                                    ),
                                                ],
                                                sources: [],
                                            },
                                        ),
                                        span: 1894..1991,
                                    },
                                ),
                                span: 1889..2008,
                            },
                        ],
                    ),
                    span: 1692..2009,
                },
            ],
            span: 407..2033,
        },
        CommandDefinition {
            persistence: Ephemeral(
                2280..2289,
            ),
            attributes: [],
            identifier: Ident {
                name: "C",
                span: 2298..2299,
            },
            fields: [
                Field(
                    FieldDefinition {
                        identifier: Ident {
                            name: "x",
                            span: 2339..2340,
                        },
                        field_type: VType {
                            kind: Int,
                            span: 2341..2344,
                        },
                    },
                ),
            ],
            seal: [],
            open: [],
            policy: [],
            recall: [],
            span: 2280..2368,
        },
    ],
    functions: [
        FunctionDefinition {
            identifier: Ident {
                name: "positive",
                span: 2052..2060,
            },
            arguments: [
                FieldDefinition {
                    identifier: Ident {
                        name: "v",
                        span: 2061..2062,
                    },
                    field_type: VType {
                        kind: Optional(
                            VType {
                                kind: Int,
                                span: 2072..2075,
                            },
                        ),
                        span: 2063..2075,
                    },
                },
            ],
            return_type: VType {
                kind: Bool,
                span: 2077..2081,
            },
            statements: [
                Statement {
                    kind: Let(
                        LetStatement {
                            identifier: Ident {
                                name: "x",
                                span: 2100..2101,
                            },
                            expression: Expression {
                                kind: Unwrap(
                                    Expression {
                                        kind: Identifier(
                                            Ident {
                                                name: "v",
                                                span: 2111..2112,
                                            },
                                        ),
                                        span: 2111..2112,
                                    },
                                ),
                                span: 2104..2112,
                            },
                        },
                    ),
                    span: 2096..2125,
                },
                Statement {
                    kind: Return(
                        ReturnStatement {
                            expression: Expression {
                                kind: GreaterThan(
                                    Expression {
                                        kind: Identifier(
                                            Ident {
                                                name: "x",
                                                span: 2132..2133,
                                            },
                                        ),
                                        span: 2132..2133,
                                    },
                                    Expression {
                                        kind: Int(
                                            0,
                                        ),
                                        span: 2136..2137,
                                    },
                                ),
                                span: 2132..2137,
                            },
                        },
                    ),
                    span: 2125..2146,
                },
            ],
            span: 2043..2147,
        },
    ],
    finish_functions: [
        FinishFunctionDefinition {
            identifier: Ident {
                name: "next",
                span: 2173..2177,
            },
            arguments: [
                FieldDefinition {
                    identifier: Ident {
                        name: "x",
                        span: 2178..2179,
                    },
                    field_type: VType {
                        kind: Int,
                        span: 2180..2183,
                    },
                },
            ],
            statements: [
                Statement {
                    kind: Create(
                        CreateStatement {
                            fact: FactLiteral {
                                identifier: Ident {
                                    name: "Next",
                                    span: 2206..2210,
                                },
                                key_fields: [],
                                value_fields: Some(
                                    [],
                                ),
                            },
                        },
                    ),
                    span: 2199..2216,
                },
            ],
            span: 2157..2226,
        },
    ],
    global_lets: [],
    text: "\n        // This is not a valid policy. It is just meant to exercise\n        // every feature of the parser.\n        /* block comment */\n        fact F[v string]=>{x int, y bool}\n\n        action add2(x int, y int) {\n            let obj = Add {\n                count: x,\n            }\n            publish obj\n        }\n\n        effect Added {\n            x int dynamic,\n            y int,\n        }\n\n        command Add {\n            fields {\n                count int\n            }\n\n            policy {\n                let envelope_id = envelope::command_id(envelope)\n                let author = envelope::author_id(envelope)\n                let new_x = add2(x, count)\n                check exists TestFact[v: \"test\"]=>{}\n                match x {\n                    0 => {\n                        check positive(Some(new_x))\n                    }\n                    1 => {\n                        check positive(None)\n                    }\n                    _ => {\n\n                    }\n                }\n\n                if x == 3 {\n                    check new_x < 10\n                }\n\n                let a = foo::ext_func(x)\n\n                finish {\n                    create F[v: \"hello\"]=>{x: x, y: saturating_sub(0, x)}\n                    update F[]=>{x: x} to {x: new_x}\n                    delete F[v: \"hello\"]\n                    emit Added {\n                        x: new_x,\n                        y: count,\n                    }\n                }\n            }\n            recall {\n                let envelope_id = envelope::command_id(envelope)\n                let author = envelope::author_id(envelope)\n                let new_x = add2(x, count)\n                finish {\n                    create F[v: \"hello\"]=>{x: x, y: saturating_sub(0, x)}\n                    update F[]=>{x: x} to {x: new_x}\n                    delete F[v: \"hello\"]\n                    emit Added {\n                        x: new_x,\n                        y: count,\n                    }\n                }\n            }\n        }\n\n        function positive(v optional int) bool {\n            let x = unwrap v\n            return x > 0\n        }\n\n        finish function next(x int) {\n            create Next[]=>{}\n        }\n\n\n        // ephemeral commands and actions\n\n        ephemeral command C {\n            fields {\n                x int\n            }\n        }\n\n        ephemeral action a() {}\n    ",
}
